<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI药物反应预测评估系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            background: #667eea;
            color: white;
        }

        .nav-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: #764ba2;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #666;
            font-size: 0.9rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page {
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* 登录页面样式 */
        .login-container {
            max-width: 500px;
            margin: 10vh auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .login-form {
            padding: 2rem;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .page-content {
            padding: 2rem;
        }

        .disease-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .disease-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .disease-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .survey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .survey-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }

        .survey-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .survey-card.completed {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-weight: bold;
            color: #333;
        }

        .card-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .card-info {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.3s ease;
        }

        .radio-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .select-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .rating-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .rating-table th,
        .rating-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .rating-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .rating-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .rating-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .rating-btn:hover {
            border-color: #667eea;
        }

        .rating-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .model-report {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .report-content {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 1rem;
            background: white;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .patient-info {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: #333;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1rem;
            font-weight: bold;
        }

        .step.active {
            background: #667eea;
        }

        .step.completed {
            background: #28a745;
        }

        .welcome-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin: 0.5rem 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .nav {
                flex-direction: column;
                gap: 1rem;
            }
            
            .survey-grid {
                grid-template-columns: 1fr;
            }
            
            .rating-controls {
                flex-wrap: wrap;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .select-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="login-container" class="login-container">
        <div class="login-header">
            <h1>🏥 AI药物反应预测评估系统</h1>
            <p>临床专家登录</p>
        </div>
        <div class="login-form">
            <!-- 步骤指示器 -->
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
            </div>

            <!-- 第一步：基本信息 -->
            <div class="form-step active" id="login-step1">
                <h3 style="margin-bottom: 1.5rem;">基本信息</h3>
                
                <div class="form-group">
                    <label class="form-label" for="doctor-name">姓名 *</label>
                    <input type="text" id="doctor-name" class="form-control" placeholder="请输入您的姓名" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="doctor-title">职称 *</label>
                        <select id="doctor-title" class="form-control" required>
                            <option value="">请选择职称</option>
                            <option value="住院医师">住院医师</option>
                            <option value="主治医师">主治医师</option>
                            <option value="副主任医师">副主任医师</option>
                            <option value="主任医师">主任医师</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="doctor-experience">工作年资 *</label>
                        <select id="doctor-experience" class="form-control" required>
                            <option value="">请选择年资</option>
                            <option value="1-3年">1-3年</option>
                            <option value="4-7年">4-7年</option>
                            <option value="8-15年">8-15年</option>
                            <option value="15年以上">15年以上</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="doctor-specialty">专业方向 *</label>
                    <select id="doctor-specialty" class="form-control" required>
                        <option value="">请选择专业方向</option>
                        <option value="肿瘤内科">肿瘤内科</option>
                        <option value="乳腺外科">乳腺外科</option>
                        <option value="胸外科">胸外科</option>
                        <option value="呼吸内科">呼吸内科</option>
                        <option value="病理科">病理科</option>
                        <option value="其他">其他</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="doctor-hospital">所在医院</label>
                    <input type="text" id="doctor-hospital" class="form-control" placeholder="请输入医院名称">
                </div>

                <button type="button" class="btn btn-primary" onclick="nextStep()">下一步</button>
            </div>

            <!-- 第二步：登录设置 -->
            <div class="form-step" id="login-step2">
                <h3 style="margin-bottom: 1.5rem;">登录设置</h3>
                
                <div class="form-group">
                    <label class="form-label" for="username">用户名 *</label>
                    <input type="text" id="username" class="form-control" placeholder="请设置用户名（建议使用姓名拼音）" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">密码 *</label>
                    <input type="password" id="password" class="form-control" placeholder="请设置密码（不少于6位）" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirm-password">确认密码 *</label>
                    <input type="password" id="confirm-password" class="form-control" placeholder="请再次输入密码" required>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">上一步</button>
                    <button type="button" class="btn btn-success" onclick="completeRegistration()">完成注册</button>
                </div>

                <div style="margin-top: 2rem; text-align: center; color: #666; font-size: 0.9rem;">
                    已有账号？<a href="#" onclick="showDirectLogin()" style="color: #667eea;">直接登录</a>
                </div>
            </div>

            <!-- 直接登录表单 -->
            <div class="form-step" id="direct-login">
                <h3 style="margin-bottom: 1.5rem;">用户登录</h3>
                
                <div class="form-group">
                    <label class="form-label" for="login-username">用户名</label>
                    <input type="text" id="login-username" class="form-control" placeholder="请输入用户名">
                </div>

                <div class="form-group">
                    <label class="form-label" for="login-password">密码</label>
                    <input type="password" id="login-password" class="form-control" placeholder="请输入密码">
                </div>

                <button type="button" class="btn btn-primary" onclick="directLogin()">登录</button>

                <div style="margin-top: 2rem; text-align: center; color: #666; font-size: 0.9rem;">
                    首次使用？<a href="#" onclick="showRegistration()" style="color: #667eea;">注册账号</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="main-app" style="display: none;">
        <header class="header">
            <nav class="nav">
                <div class="logo">AI药物反应预测评估系统</div>
                <div class="nav-buttons">
                    <!-- 管理员菜单 -->
                    <div id="admin-nav" style="display: none;">
                        <button class="nav-btn active" onclick="showPage('admin')">管理界面</button>
                        <button class="nav-btn" onclick="showPage('results')">结果统计</button>
                    </div>
                    <!-- 普通用户菜单 -->
                    <button class="nav-btn active" onclick="showPage('surveys')">问卷填写</button>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar"></div>
                    <div>
                        <div id="user-name" style="font-weight: bold;"></div>
                        <div id="user-title" style="font-size: 0.8rem;"></div>
                    </div>
                    <button class="logout-btn" onclick="logout()">退出</button>
                </div>
            </nav>
        </header>

        <div class="container">
            <!-- 管理界面 (仅管理员可见) -->
            <div id="admin" class="page active">
                <div class="page-header">
                    <h1>问卷管理系统</h1>
                    <p>管理来自GitHub的临床评估问卷</p>
                </div>
                <div class="page-content">
                    <div class="disease-tabs">
                        <button class="disease-tab active" onclick="switchDiseaseTab('breast_cancer', this)">乳腺癌</button>
                        <button class="disease-tab" onclick="switchDiseaseTab('lung_cancer', this)">非小细胞肺癌</button>
                    </div>

                    <div id="breast_cancer_content" class="disease-content">
                        <div class="upload-area">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                            <h3>乳腺癌问卷</h3>
                            <p>从GitHub获取最新问卷数据</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="loadGitHubSurveys('breast')">
                                <span id="breast-loading" style="display: none;" class="loading"></span>
                                刷新问卷列表
                            </button>
                        </div>
                        <div id="breast-surveys" class="survey-grid"></div>
                    </div>

                    <div id="lung_cancer_content" class="disease-content" style="display: none;">
                        <div class="upload-area">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                            <h3>非小细胞肺癌问卷</h3>
                            <p>从GitHub获取最新问卷数据</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="loadGitHubSurveys('lung')">
                                <span id="lung-loading" style="display: none;" class="loading"></span>
                                刷新问卷列表
                            </button>
                        </div>
                        <div id="lung-surveys" class="survey-grid"></div>
                    </div>
                </div>
            </div>

            <!-- 问卷填写界面 -->
            <div id="surveys" class="page">
                <div class="welcome-message">
                    <h2 id="welcome-text">欢迎，专家医生！</h2>
                    <p>感谢您参与AI药物反应预测模型的评估工作</p>
                </div>
                
                <div class="page-content">
                    <div class="disease-tabs">
                        <button class="disease-tab active" onclick="switchSurveyTab('breast', this)" id="breast-survey-tab">乳腺癌 (<span id="breast-count">0</span>)</button>
                        <button class="disease-tab" onclick="switchSurveyTab('lung', this)" id="lung-survey-tab">非小细胞肺癌 (<span id="lung-count">0</span>)</button>
                    </div>

                    <div id="breast-survey-list" class="survey-content">
                        <div class="survey-grid" id="breast-survey-grid">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div class="loading" style="margin: 0 auto 1rem auto;"></div>
                                <p>正在从GitHub加载问卷数据...</p>
                            </div>
                        </div>
                    </div>

                    <div id="lung-survey-list" class="survey-content" style="display: none;">
                        <div class="survey-grid" id="lung-survey-grid">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div class="loading" style="margin: 0 auto 1rem auto;"></div>
                                <p>正在从GitHub加载问卷数据...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 具体问卷填写 -->
            <div id="survey-detail" class="page">
                <div class="page-header">
                    <h1>病例 - 药物反应预测评估</h1>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="page-content">
                    <button class="btn btn-primary" onclick="showPage('surveys')" style="margin-bottom: 2rem;">← 返回问卷列表</button>
                    
                    <!-- 患者信息 -->
                    <div class="patient-info">
                        <h3 style="margin-bottom: 1rem;">患者临床信息摘要</h3>
                        <div class="info-grid" id="patient-info-grid">
                            <!-- 患者信息将动态加载 -->
                        </div>
                    </div>

                    <form id="survey-form">
                        <!-- 第一部分：临床预测 -->
                        <div class="section-title">第一部分：模型性能评估 - 临床预测</div>
                        
                        <div class="form-group">
                            <div class="form-label">1.1 您的预测</div>
                            <p style="margin-bottom: 1rem;">基于以上患者信息，请根据您的专业知识和临床经验，推断该患者在使用相应治疗后的药物反应最可能属于哪一类？</p>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="prediction" value="positive">
                                    <strong>积极响应</strong> (CR+PR)
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="prediction" value="negative">
                                    <strong>消极响应</strong> (SD+PD)
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="reasoning">1.2 您的主要判断依据是什么？（可选）</label>
                            <textarea class="form-control" id="reasoning" rows="4" placeholder="请简述影响您判断的关键因素，如特定基因突变、TMB状态、既往治疗史等"></textarea>
                        </div>

                        <!-- 第二部分：模型输出质量评估 -->
                        <div class="section-title">第二部分：模型输出文本质量评估</div>

                        <!-- 模型A报告 -->
                        <div class="model-report">
                            <div class="report-header" onclick="toggleReport('modelA')">
                                <h4>模型A：生成的报告</h4>
                                <span id="modelA-toggle">展开 ▼</span>
                            </div>
                            <div class="report-content" id="modelA-content" style="display: none;">
                                <!-- 模型A报告内容将动态加载 -->
                            </div>
                        </div>

                        <!-- 模型B报告 -->
                        <div class="model-report">
                            <div class="report-header" onclick="toggleReport('modelB')">
                                <h4>模型B：生成的报告</h4>
                                <span id="modelB-toggle">展开 ▼</span>
                            </div>
                            <div class="report-content" id="modelB-content" style="display: none;">
                                <!-- 模型B报告内容将动态加载 -->
                            </div>
                        </div>

                        <!-- 评分表 -->
                        <div class="form-group">
                            <div class="form-label">2.1 评分表</div>
                            <p>请根据以下维度对两个模型的报告进行打分 (1=非常差, 5=非常好)</p>
                            
                            <table class="rating-table">
                                <thead>
                                    <tr>
                                        <th>评估维度</th>
                                        <th>模型A (1-5分)</th>
                                        <th>模型B (1-5分)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>可读性</strong><br>
                                            <small>报告结构清晰、语言流畅、易于理解</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>信息完整性</strong><br>
                                            <small>关键临床和基因信息的呈现是否全面</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>推理逻辑性</strong><br>
                                            <small>AI分析部分的逻辑链条是否清晰、严谨、有说服力</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>临床洞察力</strong><br>
                                            <small>推理是否结合了深度的临床背景和药物机制知识</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>临床实用性</strong><br>
                                            <small>报告在多大程度上能辅助实际的临床决策</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>总体可信度</strong><br>
                                            <small>您在多大程度上信任该报告的结论和推理过程</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 综合偏好 -->
                        <div class="form-group">
                            <div class="form-label">2.2 综合偏好</div>
                            <p>总体而言，如果要在临床工作中使用，您更偏好哪个模型的报告？</p>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="preference" value="model_a">
                                    <strong>模型 A</strong>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="preference" value="model_b">
                                    <strong>模型 B</strong>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="preference" value="no_difference">
                                    <strong>两者无明显差异</strong>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="preference-reason">2.3 请简要说明您做出偏好选择的理由（可选）</label>
                            <textarea class="form-control" id="preference-reason" rows="4" placeholder="请说明您的选择理由"></textarea>
                        </div>

                        <!-- 其他反馈 -->
                        <div class="form-group">
                            <label class="form-label" for="additional-feedback">您的宝贵意见（可选）</label>
                            <textarea class="form-control" id="additional-feedback" rows="4" placeholder="如果您对本次评估或AI模型有任何额外的建议或反馈，请在此处填写"></textarea>
                        </div>

                        <div style="text-align: center; margin-top: 2rem;">
                            <button type="button" class="btn btn-success" onclick="submitSurvey()">提交问卷</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 结果统计 (仅管理员可见) -->
            <div id="results" class="page">
                <div class="page-header">
                    <h1>评估结果统计</h1>
                    <p>查看问卷收集结果和数据分析</p>
                </div>
                <div class="page-content">
                    <div class="disease-tabs">
                        <button class="disease-tab active">总体统计</button>
                        <button class="disease-tab">乳腺癌</button>
                        <button class="disease-tab">非小细胞肺癌</button>
                    </div>

                    <div class="stats-grid" id="stats-container">
                        <!-- 统计数据将通过JavaScript动态加载 -->
                    </div>

                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button class="btn btn-primary" onclick="exportResults()">导出结果数据</button>
                        <button class="btn btn-secondary" onclick="clearAllData()">清空所有数据</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GitHub配置
        const GITHUB_CONFIG = {
            // GitHub API配置
            owner: 'zhouyuru1205',
            repo: 'OncoLLM',
            apiBase: 'https://api.github.com/repos/zhouyuru1205/OncoLLM/contents',
            // GitHub Pages配置（用于获取文件内容）
            pagesBase: 'https://zhouyuru1205.github.io/OncoLLM',
            breastPath: 'questionnaires/breast',
            lungPath: 'questionnaires/lung'
        };

        // 全局变量
        const userData = {
            currentUser: null,
            githubSurveys: {
                breast: [],
                lung: []
            }
        };

        const surveyData = {
            ratings: {},
            currentSurvey: null
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            
            // 监听表单变化
            document.addEventListener('change', (e) => {
                if (e.target.type === 'radio') {
                    updateProgress();
                }
            });
        });

        // 检查登录状态
        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                userData.currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                showLoginPage();
            }
        }

        // 显示登录页面
        function showLoginPage() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        // 显示主应用
        function showMainApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const user = userData.currentUser;
            
            // 更新用户信息显示
            document.getElementById('user-avatar').textContent = user.name.charAt(0);
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-title').textContent = user.title + (user.specialty ? ' | ' + user.specialty : '');
            document.getElementById('welcome-text').textContent = `欢迎，${user.name} ${user.title}！`;
            
            // 根据角色显示不同功能
            if (user.role === 'admin') {
                document.getElementById('admin-nav').style.display = 'flex';
                showPage('admin');
                loadStatistics();
            } else {
                document.getElementById('admin-nav').style.display = 'none';
                showPage('surveys');
            }
            
            // 自动加载GitHub问卷数据
            loadGitHubSurveys('breast');
            loadGitHubSurveys('lung');
        }

        // 注册步骤控制
        let currentStep = 1;

        function nextStep() {
            // 验证第一步表单
            const name = document.getElementById('doctor-name').value;
            const title = document.getElementById('doctor-title').value;
            const experience = document.getElementById('doctor-experience').value;
            const specialty = document.getElementById('doctor-specialty').value;
            
            if (!name || !title || !experience || !specialty) {
                alert('请填写所有必填项！');
                return;
            }
            
            // 切换到第二步
            document.getElementById('login-step1').classList.remove('active');
            document.getElementById('login-step2').classList.add('active');
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            currentStep = 2;
        }

        function prevStep() {
            document.getElementById('login-step2').classList.remove('active');
            document.getElementById('login-step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
            currentStep = 1;
        }

        function showRegistration() {
            document.getElementById('direct-login').classList.remove('active');
            document.getElementById('login-step1').classList.add('active');
            // 重置步骤指示器
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active', 'completed');
            currentStep = 1;
        }

        function showDirectLogin() {
            document.getElementById('login-step1').classList.remove('active');
            document.getElementById('login-step2').classList.remove('active');
            document.getElementById('direct-login').classList.add('active');
        }

        // 完成注册
        function completeRegistration() {
            // 获取所有表单数据
            const newUserData = {
                name: document.getElementById('doctor-name').value,
                title: document.getElementById('doctor-title').value,
                experience: document.getElementById('doctor-experience').value,
                specialty: document.getElementById('doctor-specialty').value,
                hospital: document.getElementById('doctor-hospital').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                confirmPassword: document.getElementById('confirm-password').value,
                role: 'doctor',
                registrationTime: new Date().toISOString()
            };
            
            // 验证数据
            if (!newUserData.name || !newUserData.title || !newUserData.experience || 
                !newUserData.specialty || !newUserData.username || !newUserData.password) {
                alert('请填写所有必填项！');
                return;
            }
            
            if (newUserData.password !== newUserData.confirmPassword) {
                alert('两次输入的密码不一致！');
                return;
            }
            
            if (newUserData.password.length < 6) {
                alert('密码长度不能少于6位！');
                return;
            }
            
            // 检查用户名是否已存在
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            if (existingUsers.some(user => user.username === newUserData.username)) {
                alert('用户名已存在，请选择其他用户名！');
                return;
            }
            
            // 保存用户数据
            existingUsers.push(newUserData);
            localStorage.setItem('users', JSON.stringify(existingUsers));
            
            // 自动登录
            const currentUser = {
                username: newUserData.username,
                name: newUserData.name,
                title: newUserData.title,
                specialty: newUserData.specialty,
                experience: newUserData.experience,
                hospital: newUserData.hospital,
                role: newUserData.role
            };
            
            userData.currentUser = currentUser;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            alert('注册成功！欢迎使用AI药物反应预测评估系统。');
            showMainApp();
        }

        // 直接登录
        function directLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('请输入用户名和密码！');
                return;
            }
            
            // 检查用户
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // 添加管理员账户到检查列表
            const allUsers = [
                {
                    username: 'admin',
                    password: 'admin123',
                    name: '系统管理员',
                    title: '管理员',
                    role: 'admin'
                },
                ...users
            ];
            
            const user = allUsers.find(u => u.username === username && u.password === password);
            
            if (user) {
                const currentUser = {
                    username: user.username,
                    name: user.name,
                    title: user.title,
                    specialty: user.specialty,
                    experience: user.experience,
                    hospital: user.hospital,
                    role: user.role
                };
                
                userData.currentUser = currentUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
            } else {
                alert('用户名或密码错误！');
            }
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                userData.currentUser = null;
                localStorage.removeItem('currentUser');
                showLoginPage();
                
                // 重置表单
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            }
        }

        // 从GitHub加载问卷数据
        async function loadGitHubSurveys(type) {
            const loadingElement = document.getElementById(`${type}-loading`);
            const gridElement = document.getElementById(`${type}-survey-grid`);
            const countElement = document.getElementById(`${type}-count`);
            
            if (loadingElement) loadingElement.style.display = 'inline-block';
            
            try {
                const path = type === 'breast' ? GITHUB_CONFIG.breastPath : GITHUB_CONFIG.lungPath;
                
                // 使用GitHub API获取文件列表
                const apiUrl = `${GITHUB_CONFIG.apiBase}/${path}`;
                console.log('正在访问GitHub API:', apiUrl);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`GitHub API错误 ${response.status}: ${response.statusText}`);
                }
                
                const fileList = await response.json();
                console.log('GitHub API返回数据:', fileList);
                
                // 过滤出.json和.md文件
                const surveyFiles = fileList.filter(file => 
                    file.type === 'file' && 
                    (file.name.endsWith('.json') || file.name.endsWith('.md'))
                );
                
                console.log(`找到 ${surveyFiles.length} 个问卷文件:`, surveyFiles.map(f => f.name));
                
                const surveys = [];
                const loadPromises = surveyFiles.slice(0, 20).map(async (file) => { // 增加到20个文件
                    try {
                        // 使用GitHub Pages URL获取文件内容
                        const fileUrl = `${GITHUB_CONFIG.pagesBase}/${path}/${file.name}`;
                        console.log('加载文件:', fileUrl);
                        
                        const fileResponse = await fetch(fileUrl);
                        
                        if (fileResponse.ok) {
                            const content = await fileResponse.text();
                            const survey = parseGitHubSurveyData(content, file.name, type);
                            if (survey) {
                                surveys.push(survey);
                                console.log(`成功解析: ${file.name}`);
                            } else {
                                console.warn(`解析失败: ${file.name}`);
                            }
                        } else {
                            console.error(`文件加载失败 ${file.name}: ${fileResponse.status}`);
                        }
                    } catch (error) {
                        console.error(`加载文件 ${file.name} 失败:`, error);
                    }
                });
                
                await Promise.all(loadPromises);
                
                // 保存到全局变量
                userData.githubSurveys[type] = surveys;
                
                // 更新显示
                displaySurveys(surveys, gridElement);
                if (countElement) {
                    countElement.textContent = surveys.length;
                }
                
                console.log(`成功加载 ${surveys.length} 个${type === 'breast' ? '乳腺癌' : '肺癌'}问卷`);
                
            } catch (error) {
                console.error('加载GitHub问卷数据失败:', error);
                if (gridElement) {
                    gridElement.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc3545;">
                            <p>加载失败</p>
                            <p style="font-size: 0.9rem;">${error.message}</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="loadGitHubSurveys('${type}')">重试</button>
                            </div>
                            <div style="margin-top: 1rem; font-size: 0.8rem; color: #666;">
                                <p>请确保:</p>
                                <p>1. GitHub仓库是公开的</p>
                                <p>2. 文件夹 questionnaires/${type} 存在</p>
                                <p>3. 网络连接正常</p>
                            </div>
                        </div>
                    `;
                }
                if (countElement) {
                    countElement.textContent = '0';
                }
            } finally {
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        // 解析GitHub问卷数据
        function parseGitHubSurveyData(content, fileName, type) {
            try {
                let survey;
                
                if (fileName.endsWith('.json')) {
                    survey = JSON.parse(content);
                } else if (fileName.endsWith('.md')) {
                    survey = parseMarkdownSurvey(content, fileName);
                } else {
                    throw new Error('不支持的文件格式');
                }
                
                // 添加元数据
                survey.id = fileName.replace(/\.(json|md)$/, '');
                survey.fileName = fileName;
                survey.diseaseType = type === 'breast' ? 'breast_cancer' : 'lung_cancer';
                survey.source = 'github';
                
                return survey;
                
            } catch (error) {
                console.error(`解析文件 ${fileName} 失败:`, error);
                return null;
            }
        }

        // 解析Markdown格式问卷（改进版本）
        function parseMarkdownSurvey(content, fileName) {
            const survey = {
                title: '',
                caseNumber: '',
                patientId: '',
                drugs: [],
                patientInfo: {
                    gender: '',
                    age: '',
                    race: '',
                    ethnicity: '',
                    smoking: '',
                    diagnosis: '',
                    hrStatus: '',
                    her2Status: '',
                    stage: '',
                    tmb: '',
                    msiStatus: '',
                    msiScore: '',
                    mutations: '',
                    previousTreatment: '',
                    sampleType: '',
                    cancerType: '',
                    cancerDetailType: '',
                    primarySite: '',
                    sampleId: '',
                    structuralVariants: '',
                    clinicalGroup: '',
                    pathologyGroup: '',
                    derivedStage: '',
                    summary: '',
                    laboratoryResults: {}
                },
                modelReports: {
                    modelA: '',
                    modelB: ''
                }
            };
            
            // 提取病例编号
            const caseMatch = content.match(/(?:\*\*病例|病例)\s*(\d+)\*\*/);
            if (caseMatch) {
                survey.caseNumber = caseMatch[1];
                survey.title = `病例 ${caseMatch[1]}`;
            }
            
            // 提取患者ID
            const patientIdMatch = content.match(/[\-\*\s]*患者ID[：:]\s*(P-[\w\d-]+)/);
            if (patientIdMatch) {
                survey.patientId = patientIdMatch[1];
            }
            
            // 提取治疗药物
            const drugMatch = content.match(/[\-\*\s]*治疗药物[：:]\s*([^\n\r]+)/);
            if (drugMatch) {
                let drugText = drugMatch[1];
                // 移除括号内的英文名称，保留中文名称
                drugText = drugText.replace(/\s*\([^)]*\)/g, '');
                survey.drugs = drugText.split(/[,，]/).map(d => d.trim()).filter(d => d.length > 0);
            }
            
            // 提取基本信息部分
            const basicInfoMatch = content.match(/\*\*基本信息:\*\*([\s\S]*?)(?=\*\*诊断与分期|\*\*既往主要治疗|\*\*基因图谱)/);
            if (basicInfoMatch) {
                const basicInfo = basicInfoMatch[1];
                const extractBasicInfo = (pattern, field) => {
                    const match = basicInfo.match(new RegExp(`-\\s*${pattern}[：:]\\s*([^\n\r]+)`, 'g'));
                    if (match && match[0]) {
                        const value = match[0].replace(new RegExp(`-\\s*${pattern}[：:]\\s*`), '').trim();
                        survey.patientInfo[field] = value;
                    }
                };
                
                extractBasicInfo('性别', 'gender');
                extractBasicInfo('年龄', 'age');
                extractBasicInfo('种族', 'race');
                extractBasicInfo('族裔', 'ethnicity');
                extractBasicInfo('吸烟史', 'smoking');
            }
            
            // 提取诊断与分期部分
            const diagnosisMatch = content.match(/\*\*诊断与分期:\*\*([\s\S]*?)(?=\*\*既往主要治疗|\*\*基因图谱)/);
            if (diagnosisMatch) {
                const diagnosisInfo = diagnosisMatch[1];
                const extractDiagnosisInfo = (pattern, field) => {
                    const match = diagnosisInfo.match(new RegExp(`-\\s*${pattern}[：:]\\s*([^\n\r]+)`, 'g'));
                    if (match && match[0]) {
                        const value = match[0].replace(new RegExp(`-\\s*${pattern}[：:]\\s*`), '').trim();
                        survey.patientInfo[field] = value;
                    }
                };
                
                extractDiagnosisInfo('诊断', 'diagnosis');
                extractDiagnosisInfo('HR状态', 'hrStatus');
                extractDiagnosisInfo('HER2状态', 'her2Status');
                extractDiagnosisInfo('最高记录分期', 'stage');
                extractDiagnosisInfo('临床组别', 'clinicalGroup');
                extractDiagnosisInfo('病理组别', 'pathologyGroup');
                extractDiagnosisInfo('衍生分期', 'derivedStage');
                extractDiagnosisInfo('摘要', 'summary');
            }
            
            // 提取既往治疗
            const treatmentMatch = content.match(/\*\*既往主要治疗:\*\*\s*([^\n\r]+)/);
            if (treatmentMatch) {
                survey.patientInfo.previousTreatment = treatmentMatch[1].trim();
            }
            
            // 提取基因图谱信息
            const geneMatch = content.match(/\*\*基因图谱:\*\*([\s\S]*?)(?=\*\*1\.1|---)/);
            if (geneMatch) {
                const geneInfo = geneMatch[1];
                
                const tmbMatch = geneInfo.match(/-\s*TMB[^：:]*[：:]\s*([^\n\r]+)/);
                if (tmbMatch) survey.patientInfo.tmb = tmbMatch[1].trim();
                
                const mutationMatch = geneInfo.match(/-\s*关键基因突变[：:]\s*([^\n\r]+)/);
                if (mutationMatch) survey.patientInfo.mutations = mutationMatch[1].trim();
                
                const msiMatch = geneInfo.match(/-\s*MSI状态[：:]\s*([^\n\r]+)/);
                if (msiMatch) survey.patientInfo.msiStatus = msiMatch[1].trim();
                
                const msiScoreMatch = geneInfo.match(/-\s*MSI评分[：:]\s*([^\n\r]+)/);
                if (msiScoreMatch) survey.patientInfo.msiScore = msiScoreMatch[1].trim();
            }
            
            // 从详细报告中提取更多信息（如实验室结果）
            const extractLabResults = () => {
                // CEA结果
                const ceaMatch = content.match(/CEA[：:]?\s*([^\n\r,，]+)/);
                if (ceaMatch) survey.patientInfo.laboratoryResults.CEA = ceaMatch[1].trim();
                
                // CA 15-3结果
                const ca153Match = content.match(/CA\s*15-3[：:]?\s*([^\n\r,，]+)/);
                if (ca153Match) survey.patientInfo.laboratoryResults['CA 15-3'] = ca153Match[1].trim();
                
                // CA 19-9结果
                const ca199Match = content.match(/CA\s*19-9[：:]?\s*([^\n\r,，]+)/);
                if (ca199Match) survey.patientInfo.laboratoryResults['CA 19-9'] = ca199Match[1].trim();
                
                // 样本信息
                const sampleIdMatch = content.match(/样本ID[：:]\s*([^\n\r（]+)/);
                if (sampleIdMatch) survey.patientInfo.sampleId = sampleIdMatch[1].trim();
                
                const cancerTypeMatch = content.match(/癌症类型[：:]\s*([^\n\r]+)/);
                if (cancerTypeMatch) survey.patientInfo.cancerType = cancerTypeMatch[1].trim();
                
                const cancerDetailMatch = content.match(/癌症详细类型[：:]\s*([^\n\r]+)/);
                if (cancerDetailMatch) survey.patientInfo.cancerDetailType = cancerDetailMatch[1].trim();
                
                const primarySiteMatch = content.match(/原发部位[：:]\s*([^\n\r]+)/);
                if (primarySiteMatch) survey.patientInfo.primarySite = primarySiteMatch[1].trim();
                
                const sampleTypeMatch = content.match(/样本类型[：:]\s*([^\n\r]+)/);
                if (sampleTypeMatch) survey.patientInfo.sampleType = sampleTypeMatch[1].trim();
                
                const structuralMatch = content.match(/结构变异[：:]\s*([^\n\r]+)/);
                if (structuralMatch) survey.patientInfo.structuralVariants = structuralMatch[1].trim();
            };
            
            extractLabResults();
            
            // 提取模型A的AI分析部分
            const extractModelAnalysis = (modelName) => {
                // 首先找到模型报告的<details>标签内容
                const detailsPattern = new RegExp(`\\*\\*模型${modelName}：生成的报告\\*\\*[\\s\\S]*?<details>[\\s\\S]*?<summary>[\\s\\S]*?</summary>([\\s\\S]*?)</details>`, 'i');
                const detailsMatch = content.match(detailsPattern);
                
                if (detailsMatch) {
                    const reportContent = detailsMatch[1];
                    // 提取"5. AI生成分析"部分
                    const aiAnalysisMatch = reportContent.match(/\*\*5\.\s*AI生成分析\*\*([\s\S]*?)(?=\*\*注|$)/);
                    if (aiAnalysisMatch) {
                        return aiAnalysisMatch[1].trim();
                    }
                }
                return '';
            };
            
            survey.modelReports.modelA = extractModelAnalysis('A');
            survey.modelReports.modelB = extractModelAnalysis('B');
            
            // 验证解析结果
            console.log(`解析 ${fileName}:`, {
                title: survey.title,
                patientId: survey.patientId,
                drugs: survey.drugs,
                basicInfo: {
                    gender: survey.patientInfo.gender,
                    age: survey.patientInfo.age,
                    diagnosis: survey.patientInfo.diagnosis
                },
                hasModelA: !!survey.modelReports.modelA,
                hasModelB: !!survey.modelReports.modelB,
                modelALength: survey.modelReports.modelA.length,
                modelBLength: survey.modelReports.modelB.length
            });
            
            return survey;
        }

        // 显示问卷列表
        function displaySurveys(surveys, container) {
            if (!container) return;
            
            if (surveys.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>暂无问卷数据</p>
                        <p style="font-size: 0.9rem;">请检查GitHub数据源</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            surveys.forEach(survey => {
                const surveyCard = document.createElement('div');
                surveyCard.className = 'survey-card';
                surveyCard.onclick = () => openGitHubSurvey(survey);
                
                const drugsText = Array.isArray(survey.drugs) ? 
                    survey.drugs.join(' + ') : 
                    (survey.drug || survey.drugs || '未知药物');
                
                surveyCard.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${survey.title || survey.fileName}</div>
                        <div class="card-status status-pending">GitHub</div>
                    </div>
                    <div class="card-info">
                        <strong>患者ID:</strong> ${survey.patientId || '未知'}<br>
                        <strong>治疗药物:</strong> ${drugsText}<br>
                        <small style="color: #666;">文件: ${survey.fileName}</small>
                    </div>
                `;
                
                container.appendChild(surveyCard);
            });
        }

        // 打开GitHub问卷
        function openGitHubSurvey(survey) {
            surveyData.currentSurvey = survey;
            renderSurveyDetail(survey);
            showPage('survey-detail');
        }

        // 渲染问卷详情
        function renderSurveyDetail(survey) {
            const patientInfo = survey.patientInfo || {};
            const drugs = Array.isArray(survey.drugs) ? survey.drugs : [survey.drug || survey.drugs];
            const drugsText = drugs.filter(d => d).join(' + ');
            
            // 更新页面标题
            const pageHeader = document.querySelector('#survey-detail .page-header h1');
            if (pageHeader) {
                pageHeader.textContent = `${survey.title || survey.fileName} - 药物反应预测评估`;
            }
            
            // 生成患者信息
            const patientInfoContainer = document.getElementById('patient-info-grid');
            if (patientInfoContainer) {
                patientInfoContainer.innerHTML = generatePatientInfoHTML(survey, patientInfo, drugsText);
            }
            
            // 更新模型报告
            updateModelReports(survey.modelReports);
            
            // 重置表单
            const form = document.getElementById('survey-form');
            if (form) {
                form.reset();
            }
            
            // 重置评分
            surveyData.ratings = {};
            document.querySelectorAll('.rating-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            updateProgress();
        }

        // 生成患者信息HTML
        function generatePatientInfoHTML(survey, patientInfo, drugsText) {
            let html = '';
            
            html += createInfoItem('患者ID', survey.patientId);
            html += createInfoItem('治疗药物', drugsText);
            
            // 其他患者信息...
            if (patientInfo.gender) html += createInfoItem('性别', patientInfo.gender);
            if (patientInfo.age) html += createInfoItem('年龄', patientInfo.age);
            if (patientInfo.diagnosis) html += createInfoItem('诊断', patientInfo.diagnosis);
            
            return html;
        }

        // 创建信息项HTML
        function createInfoItem(label, value) {
            if (!value) return '';
            return `
                <div class="info-item">
                    <div class="info-label">${label}</div>
                    <div class="info-value">${value}</div>
                </div>
            `;
        }

        // 更新模型报告
        function updateModelReports(modelReports) {
            if (!modelReports) return;
            
            const modelAContent = document.getElementById('modelA-content');
            const modelBContent = document.getElementById('modelB-content');
            
            if (modelAContent && modelReports.modelA) {
                modelAContent.innerHTML = formatModelReport(modelReports.modelA);
            }
            
            if (modelBContent && modelReports.modelB) {
                modelBContent.innerHTML = formatModelReport(modelReports.modelB);
            }
        }

        // 格式化模型报告
        function formatModelReport(reportText) {
            if (!reportText) return '';
            
            return reportText
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^\s*/, '<p>')
                .replace(/\s*$/, '</p>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        // 页面切换
        function showPage(pageId) {
            // 权限检查
            if ((pageId === 'admin' || pageId === 'results') && userData.currentUser.role !== 'admin') {
                alert('您没有权限访问该页面！');
                return;
            }
            
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示目标页面
            document.getElementById(pageId).classList.add('active');
            
            // 更新导航按钮状态
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn => 
                btn.textContent.includes(getPageTitle(pageId))
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }

        function getPageTitle(pageId) {
            const titles = {
                'admin': '管理界面',
                'surveys': '问卷填写', 
                'survey-detail': '问卷详情',
                'results': '结果统计'
            };
            return titles[pageId] || '';
        }

        // 标签切换
        function switchDiseaseTab(disease, element) {
            element.parentElement.querySelectorAll('.disease-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            document.querySelectorAll('.disease-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(disease + '_content').style.display = 'block';
        }

        function switchSurveyTab(type, element) {
            element.parentElement.querySelectorAll('.disease-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            document.querySelectorAll('.survey-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(type + '-survey-list').style.display = 'block';
        }

        // 评分功能
        function setRating(category, value, element) {
            surveyData.ratings[category] = value;
            
            const container = element.parentElement;
            container.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
            
            updateProgress();
        }

        // 更新进度条
        function updateProgress() {
            const form = document.getElementById('survey-form');
            if (!form) return;
            
            const requiredInputs = form.querySelectorAll('input[type="radio"]:checked');
            const totalRequired = 8; // 预测 + 偏好 + 6个评分维度
            const progress = Math.min((requiredInputs.length / totalRequired) * 100, 100);
            
            const progressFill = document.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
        }

        // 切换报告显示
        function toggleReport(modelId) {
            const content = document.getElementById(modelId + '-content');
            const toggle = document.getElementById(modelId + '-toggle');
            
            if (content && toggle) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = '收起 ▲';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = '展开 ▼';
                }
            }
        }

        // 提交问卷
        function submitSurvey() {
            const form = document.getElementById('survey-form');
            if (!form) return;
            
            if (!surveyData.currentSurvey) {
                alert('问卷数据不完整，请重新选择问卷！');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // 验证必填项
            if (!data.prediction) {
                alert('请选择您的预测结果！');
                return;
            }
            
            if (!data.preference) {
                alert('请选择您的模型偏好！');
                return;
            }
            
            // 添加评分数据
            data.ratings = surveyData.ratings;
            data.reasoning = document.getElementById('reasoning')?.value || '';
            data.preferenceReason = document.getElementById('preference-reason')?.value || '';
            data.additionalFeedback = document.getElementById('additional-feedback')?.value || '';
            data.timestamp = new Date().toISOString();
            data.doctorInfo = userData.currentUser;
            data.surveyInfo = {
                id: surveyData.currentSurvey.id,
                fileName: surveyData.currentSurvey.fileName,
                patientId: surveyData.currentSurvey.patientId,
                title: surveyData.currentSurvey.title,
                diseaseType: surveyData.currentSurvey.diseaseType,
                source: surveyData.currentSurvey.source
            };
            
            // 保存到本地存储
            const existingResults = JSON.parse(localStorage.getItem('surveyResults') || '[]');
            existingResults.push(data);
            localStorage.setItem('surveyResults', JSON.stringify(existingResults));
            
            console.log('问卷提交成功:', data);
            
            alert('问卷提交成功！感谢您的参与。');
            
            // 刷新统计数据
            if (userData.currentUser.role === 'admin') {
                loadStatistics();
            }
            
            showPage('surveys');
        }

        // 加载统计数据
        function loadStatistics() {
            try {
                const surveyResults = JSON.parse(localStorage.getItem('surveyResults') || '[]');
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                // 计算总问卷数（从GitHub数据）
                const totalGithubSurveys = userData.githubSurveys.breast.length + userData.githubSurveys.lung.length;
                const completed = surveyResults.length;
                const completionRate = totalGithubSurveys > 0 ? ((completed / totalGithubSurveys) * 100).toFixed(1) : '0';
                
                const statsContainer = document.getElementById('stats-container');
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <div class="stat-card">
                            <h3 style="color: #667eea; margin-bottom: 1rem;">总问卷数</h3>
                            <div class="stat-number">${totalGithubSurveys}</div>
                            <div class="stat-label">GitHub问卷</div>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: #28a745; margin-bottom: 1rem;">已完成</h3>
                            <div class="stat-number">${completed}</div>
                            <div class="stat-label">完成率: ${completionRate}%</div>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: #17a2b8; margin-bottom: 1rem;">乳腺癌</h3>
                            <div class="stat-number">${userData.githubSurveys.breast.length}</div>
                            <div class="stat-label">可用问卷</div>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: #ffc107; margin-bottom: 1rem;">肺癌</h3>
                            <div class="stat-number">${userData.githubSurveys.lung.length}</div>
                            <div class="stat-label">可用问卷</div>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: #dc3545; margin-bottom: 1rem;">注册医生</h3>
                            <div class="stat-number">${users.length}</div>
                            <div class="stat-label">参与专家</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 导出结果
        function exportResults() {
            try {
                const surveyResults = JSON.parse(localStorage.getItem('surveyResults') || '[]');
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                const results = {
                    summary: {
                        totalGitHubSurveys: userData.githubSurveys.breast.length + userData.githubSurveys.lung.length,
                        breastSurveys: userData.githubSurveys.breast.length,
                        lungSurveys: userData.githubSurveys.lung.length,
                        completedSurveys: surveyResults.length,
                        totalUsers: users.length,
                        completionRate: ((surveyResults.length / (userData.githubSurveys.breast.length + userData.githubSurveys.lung.length)) * 100).toFixed(1) + '%'
                    },
                    gitHubSurveys: {
                        breast: userData.githubSurveys.breast.map(s => ({
                            id: s.id,
                            fileName: s.fileName,
                            title: s.title,
                            patientId: s.patientId,
                            drugs: s.drugs
                        })),
                        lung: userData.githubSurveys.lung.map(s => ({
                            id: s.id,
                            fileName: s.fileName,
                            title: s.title,
                            patientId: s.patientId,
                            drugs: s.drugs
                        }))
                    },
                    surveyResults: surveyResults,
                    users: users.map(user => ({
                        name: user.name,
                        title: user.title,
                        specialty: user.specialty,
                        experience: user.experience,
                        hospital: user.hospital,
                        registrationTime: user.registrationTime
                    })),
                    exportTime: new Date().toISOString(),
                    exportedBy: userData.currentUser?.name || '系统管理员'
                };
                
                const dataStr = JSON.stringify(results, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'survey_results_' + new Date().toISOString().slice(0,10) + '.json';
                a.click();
                URL.revokeObjectURL(url);
                
                alert('数据导出成功！');
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败：' + error.message);
            }
        }

        // 清空所有数据
        function clearAllData() {
            if (confirm('确定要清空所有数据吗？这将删除所有填写结果！\n\n此操作不可恢复！')) {
                if (confirm('请再次确认：您真的要删除所有数据吗？')) {
                    localStorage.removeItem('surveyResults');
                    loadStatistics();
                    alert('所有数据已清空！');
                }
            }
        }
    </script>
</body>
</html>
