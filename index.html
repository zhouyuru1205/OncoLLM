<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¯ç‰©ååº”é¢„æµ‹è¯„ä¼°ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            background: #667eea;
            color: white;
        }

        .nav-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: #764ba2;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #666;
            font-size: 0.9rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page {
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            max-width: 500px;
            margin: 10vh auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .login-form {
            padding: 2rem;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .page-content {
            padding: 2rem;
        }

        .disease-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .disease-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .disease-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .survey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .survey-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }

        .survey-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .survey-card.completed {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-weight: bold;
            color: #333;
        }

        .card-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .card-info {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.3s ease;
        }

        .radio-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .select-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .rating-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .rating-table th,
        .rating-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .rating-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .rating-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .rating-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .rating-btn:hover {
            border-color: #667eea;
        }

        .rating-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .model-report {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .report-content {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 1rem;
            background: white;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .patient-info {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: #333;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1rem;
            font-weight: bold;
        }

        .step.active {
            background: #667eea;
        }

        .step.completed {
            background: #28a745;
        }

        .welcome-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin: 0.5rem 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .nav {
                flex-direction: column;
                gap: 1rem;
            }
            
            .survey-grid {
                grid-template-columns: 1fr;
            }
            
            .rating-controls {
                flex-wrap: wrap;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .select-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-container" class="login-container">
        <div class="login-header">
            <h1>ğŸ¥ AIè¯ç‰©ååº”é¢„æµ‹è¯„ä¼°ç³»ç»Ÿ</h1>
            <p>ä¸´åºŠä¸“å®¶ç™»å½•</p>
        </div>
        <div class="login-form">
            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
            </div>

            <!-- ç¬¬ä¸€æ­¥ï¼šåŸºæœ¬ä¿¡æ¯ -->
            <div class="form-step active" id="login-step1">
                <h3 style="margin-bottom: 1.5rem;">åŸºæœ¬ä¿¡æ¯</h3>
                
                <div class="form-group">
                    <label class="form-label" for="doctor-name">å§“å *</label>
                    <input type="text" id="doctor-name" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="doctor-title">èŒç§° *</label>
                        <select id="doctor-title" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©èŒç§°</option>
                            <option value="ä½é™¢åŒ»å¸ˆ">ä½é™¢åŒ»å¸ˆ</option>
                            <option value="ä¸»æ²»åŒ»å¸ˆ">ä¸»æ²»åŒ»å¸ˆ</option>
                            <option value="å‰¯ä¸»ä»»åŒ»å¸ˆ">å‰¯ä¸»ä»»åŒ»å¸ˆ</option>
                            <option value="ä¸»ä»»åŒ»å¸ˆ">ä¸»ä»»åŒ»å¸ˆ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="doctor-experience">å·¥ä½œå¹´èµ„ *</label>
                        <select id="doctor-experience" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©å¹´èµ„</option>
                            <option value="1-3å¹´">1-3å¹´</option>
                            <option value="4-7å¹´">4-7å¹´</option>
                            <option value="8-15å¹´">8-15å¹´</option>
                            <option value="15å¹´ä»¥ä¸Š">15å¹´ä»¥ä¸Š</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="doctor-specialty">ä¸“ä¸šæ–¹å‘ *</label>
                    <select id="doctor-specialty" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©ä¸“ä¸šæ–¹å‘</option>
                        <option value="è‚¿ç˜¤å†…ç§‘">è‚¿ç˜¤å†…ç§‘</option>
                        <option value="ä¹³è…ºå¤–ç§‘">ä¹³è…ºå¤–ç§‘</option>
                        <option value="èƒ¸å¤–ç§‘">èƒ¸å¤–ç§‘</option>
                        <option value="å‘¼å¸å†…ç§‘">å‘¼å¸å†…ç§‘</option>
                        <option value="ç—…ç†ç§‘">ç—…ç†ç§‘</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="doctor-hospital">æ‰€åœ¨åŒ»é™¢</label>
                    <input type="text" id="doctor-hospital" class="form-control" placeholder="è¯·è¾“å…¥åŒ»é™¢åç§°">
                </div>

                <button type="button" class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
            </div>

            <!-- ç¬¬äºŒæ­¥ï¼šç™»å½•è®¾ç½® -->
            <div class="form-step" id="login-step2">
                <h3 style="margin-bottom: 1.5rem;">ç™»å½•è®¾ç½®</h3>
                
                <div class="form-group">
                    <label class="form-label" for="username">ç”¨æˆ·å *</label>
                    <input type="text" id="username" class="form-control" placeholder="è¯·è®¾ç½®ç”¨æˆ·åï¼ˆå»ºè®®ä½¿ç”¨å§“åæ‹¼éŸ³ï¼‰" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">å¯†ç  *</label>
                    <input type="password" id="password" class="form-control" placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆä¸å°‘äº6ä½ï¼‰" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirm-password">ç¡®è®¤å¯†ç  *</label>
                    <input type="password" id="confirm-password" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                    <button type="button" class="btn btn-success" onclick="completeRegistration()">å®Œæˆæ³¨å†Œ</button>
                </div>

                <div style="margin-top: 2rem; text-align: center; color: #666; font-size: 0.9rem;">
                    å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showDirectLogin()" style="color: #667eea;">ç›´æ¥ç™»å½•</a>
                </div>
            </div>

            <!-- ç›´æ¥ç™»å½•è¡¨å• -->
            <div class="form-step" id="direct-login">
                <h3 style="margin-bottom: 1.5rem;">ç”¨æˆ·ç™»å½•</h3>
                
                <div class="form-group">
                    <label class="form-label" for="login-username">ç”¨æˆ·å</label>
                    <input type="text" id="login-username" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>

                <div class="form-group">
                    <label class="form-label" for="login-password">å¯†ç </label>
                    <input type="password" id="login-password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>

                <button type="button" class="btn btn-primary" onclick="directLogin()">ç™»å½•</button>

                <div style="margin-top: 2rem; text-align: center; color: #666; font-size: 0.9rem;">
                    é¦–æ¬¡ä½¿ç”¨ï¼Ÿ<a href="#" onclick="showRegistration()" style="color: #667eea;">æ³¨å†Œè´¦å·</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-app" style="display: none;">
        <header class="header">
            <nav class="nav">
                <div class="logo">AIè¯ç‰©ååº”é¢„æµ‹è¯„ä¼°ç³»ç»Ÿ</div>
                <div class="nav-buttons">
                    <!-- ç®¡ç†å‘˜èœå• -->
                    <div id="admin-nav" style="display: none;">
                        <button class="nav-btn active" onclick="showPage('admin')">ç®¡ç†ç•Œé¢</button>
                        <button class="nav-btn" onclick="showPage('results')">ç»“æœç»Ÿè®¡</button>
                    </div>
                    <!-- æ™®é€šç”¨æˆ·èœå• -->
                    <button class="nav-btn active" onclick="showPage('surveys')">é—®å·å¡«å†™</button>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar"></div>
                    <div>
                        <div id="user-name" style="font-weight: bold;"></div>
                        <div id="user-title" style="font-size: 0.8rem;"></div>
                    </div>
                    <button class="logout-btn" onclick="logout()">é€€å‡º</button>
                </div>
            </nav>
        </header>

        <div class="container">
            <!-- ç®¡ç†ç•Œé¢ (ä»…ç®¡ç†å‘˜å¯è§) -->
            <div id="admin" class="page active">
                <div class="page-header">
                    <h1>é—®å·ç®¡ç†ç³»ç»Ÿ</h1>
                    <p>ç®¡ç†æ¥è‡ªGitHubçš„ä¸´åºŠè¯„ä¼°é—®å·</p>
                </div>
                <div class="page-content">
                    <div class="disease-tabs">
                        <button class="disease-tab active" onclick="switchDiseaseTab('breast_cancer', this)">ä¹³è…ºç™Œ</button>
                        <button class="disease-tab" onclick="switchDiseaseTab('lung_cancer', this)">éå°ç»†èƒè‚ºç™Œ</button>
                    </div>

                    <div id="breast_cancer_content" class="disease-content">
                        <div class="upload-area">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“‹</div>
                            <h3>ä¹³è…ºç™Œé—®å·</h3>
                            <p>ä»GitHubè·å–æœ€æ–°é—®å·æ•°æ®</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="loadGitHubSurveys('breast')">
                                <span id="breast-loading" style="display: none;" class="loading"></span>
                                åˆ·æ–°é—®å·åˆ—è¡¨
                            </button>
                        </div>
                        <div id="breast-surveys" class="survey-grid"></div>
                    </div>

                    <div id="lung_cancer_content" class="disease-content" style="display: none;">
                        <div class="upload-area">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“‹</div>
                            <h3>éå°ç»†èƒè‚ºç™Œé—®å·</h3>
                            <p>ä»GitHubè·å–æœ€æ–°é—®å·æ•°æ®</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="loadGitHubSurveys('lung')">
                                <span id="lung-loading" style="display: none;" class="loading"></span>
                                åˆ·æ–°é—®å·åˆ—è¡¨
                            </button>
                        </div>
                        <div id="lung-surveys" class="survey-grid"></div>
                    </div>
                </div>
            </div>

            <!-- é—®å·å¡«å†™ç•Œé¢ -->
            <div id="surveys" class="page">
                <div class="welcome-message">
                    <h2 id="welcome-text">æ¬¢è¿ï¼Œä¸“å®¶åŒ»ç”Ÿï¼</h2>
                    <p>æ„Ÿè°¢æ‚¨å‚ä¸AIè¯ç‰©ååº”é¢„æµ‹æ¨¡å‹çš„è¯„ä¼°å·¥ä½œ</p>
                </div>
                
                <div class="page-content">
                    <div class="disease-tabs">
                        <button class="disease-tab active" onclick="switchSurveyTab('breast', this)" id="breast-survey-tab">ä¹³è…ºç™Œ (<span id="breast-count">0</span>)</button>
                        <button class="disease-tab" onclick="switchSurveyTab('lung', this)" id="lung-survey-tab">éå°ç»†èƒè‚ºç™Œ (<span id="lung-count">0</span>)</button>
                    </div>

                    <div id="breast-survey-list" class="survey-content">
                        <div class="survey-grid" id="breast-survey-grid">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div class="loading" style="margin: 0 auto 1rem auto;"></div>
                                <p>æ­£åœ¨ä»GitHubåŠ è½½é—®å·æ•°æ®...</p>
                            </div>
                        </div>
                    </div>

                    <div id="lung-survey-list" class="survey-content" style="display: none;">
                        <div class="survey-grid" id="lung-survey-grid">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div class="loading" style="margin: 0 auto 1rem auto;"></div>
                                <p>æ­£åœ¨ä»GitHubåŠ è½½é—®å·æ•°æ®...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å…·ä½“é—®å·å¡«å†™ -->
            <div id="survey-detail" class="page">
                <div class="page-header">
                    <h1>ç—…ä¾‹ - è¯ç‰©ååº”é¢„æµ‹è¯„ä¼°</h1>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="page-content">
                    <button class="btn btn-primary" onclick="showPage('surveys')" style="margin-bottom: 2rem;">â† è¿”å›é—®å·åˆ—è¡¨</button>
                    
                    <!-- æ‚£è€…ä¿¡æ¯ -->
                    <div class="patient-info">
                        <h3 style="margin-bottom: 1rem;">æ‚£è€…ä¸´åºŠä¿¡æ¯æ‘˜è¦</h3>
                        <div class="info-grid" id="patient-info-grid">
                            <!-- æ‚£è€…ä¿¡æ¯å°†åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>

                    <form id="survey-form">
                        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸´åºŠé¢„æµ‹ -->
                        <div class="section-title">ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¨¡å‹æ€§èƒ½è¯„ä¼° - ä¸´åºŠé¢„æµ‹</div>
                        
                        <div class="form-group">
                            <div class="form-label">1.1 æ‚¨çš„é¢„æµ‹</div>
                            <p style="margin-bottom: 1rem;">åŸºäºä»¥ä¸Šæ‚£è€…ä¿¡æ¯ï¼Œè¯·æ ¹æ®æ‚¨çš„ä¸“ä¸šçŸ¥è¯†å’Œä¸´åºŠç»éªŒï¼Œæ¨æ–­è¯¥æ‚£è€…åœ¨ä½¿ç”¨ç›¸åº”æ²»ç–—åçš„è¯ç‰©ååº”æœ€å¯èƒ½å±äºå“ªä¸€ç±»ï¼Ÿ</p>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="prediction" value="positive">
                                    <strong>ç§¯æå“åº”</strong> (CR+PR)
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="prediction" value="negative">
                                    <strong>æ¶ˆæå“åº”</strong> (SD+PD)
                                </label>
                            </div>
                        </div>

                        <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šæ¨¡å‹è¾“å‡ºè´¨é‡è¯„ä¼° -->
                        <div class="section-title">ç¬¬äºŒéƒ¨åˆ†ï¼šæ¨¡å‹è¾“å‡ºæ–‡æœ¬è´¨é‡è¯„ä¼°</div>

                        <!-- æ¨¡å‹AæŠ¥å‘Š -->
                        <div class="model-report">
                            <div class="report-header" onclick="toggleReport('modelA')">
                                <h4>æ¨¡å‹Aï¼šç”Ÿæˆçš„æŠ¥å‘Š</h4>
                                <span id="modelA-toggle">å±•å¼€ â–¼</span>
                            </div>
                            <div class="report-content" id="modelA-content" style="display: none;">
                                <!-- æ¨¡å‹AæŠ¥å‘Šå†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>

                        <!-- æ¨¡å‹BæŠ¥å‘Š -->
                        <div class="model-report">
                            <div class="report-header" onclick="toggleReport('modelB')">
                                <h4>æ¨¡å‹Bï¼šç”Ÿæˆçš„æŠ¥å‘Š</h4>
                                <span id="modelB-toggle">å±•å¼€ â–¼</span>
                            </div>
                            <div class="report-content" id="modelB-content" style="display: none;">
                                <!-- æ¨¡å‹BæŠ¥å‘Šå†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>

                        <!-- è¯„åˆ†è¡¨ -->
                        <div class="form-group">
                            <div class="form-label">2.1 è¯„åˆ†è¡¨</div>
                            <p>è¯·æ ¹æ®ä»¥ä¸‹ç»´åº¦å¯¹ä¸¤ä¸ªæ¨¡å‹çš„æŠ¥å‘Šè¿›è¡Œæ‰“åˆ† (1=éå¸¸å·®, 5=éå¸¸å¥½)</p>
                            
                            <table class="rating-table">
                                <thead>
                                    <tr>
                                        <th>è¯„ä¼°ç»´åº¦</th>
                                        <th>æ¨¡å‹A (1-5åˆ†)</th>
                                        <th>æ¨¡å‹B (1-5åˆ†)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>å¯è¯»æ€§</strong><br>
                                            <small>æŠ¥å‘Šç»“æ„æ¸…æ™°ã€è¯­è¨€æµç•…ã€æ˜“äºç†è§£</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('readability_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>ä¿¡æ¯å®Œæ•´æ€§</strong><br>
                                            <small>å…³é”®ä¸´åºŠå’ŒåŸºå› ä¿¡æ¯çš„å‘ˆç°æ˜¯å¦å…¨é¢</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('completeness_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>æ¨ç†é€»è¾‘æ€§</strong><br>
                                            <small>AIåˆ†æéƒ¨åˆ†çš„é€»è¾‘é“¾æ¡æ˜¯å¦æ¸…æ™°ã€ä¸¥è°¨ã€æœ‰è¯´æœåŠ›</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('logic_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>ä¸´åºŠæ´å¯ŸåŠ›</strong><br>
                                            <small>æ¨ç†æ˜¯å¦ç»“åˆäº†æ·±åº¦çš„ä¸´åºŠèƒŒæ™¯å’Œè¯ç‰©æœºåˆ¶çŸ¥è¯†</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('insight_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>ä¸´åºŠå®ç”¨æ€§</strong><br>
                                            <small>æŠ¥å‘Šåœ¨å¤šå¤§ç¨‹åº¦ä¸Šèƒ½è¾…åŠ©å®é™…çš„ä¸´åºŠå†³ç­–</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('utility_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>æ€»ä½“å¯ä¿¡åº¦</strong><br>
                                            <small>æ‚¨åœ¨å¤šå¤§ç¨‹åº¦ä¸Šä¿¡ä»»è¯¥æŠ¥å‘Šçš„ç»“è®ºå’Œæ¨ç†è¿‡ç¨‹</small>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_a', 5, this)">5</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rating-controls">
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 1, this)">1</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 2, this)">2</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 3, this)">3</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 4, this)">4</button>
                                                <button type="button" class="rating-btn" onclick="setRating('trust_b', 5, this)">5</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- ç»¼åˆåå¥½ -->
                        <div class="form-group">
                            <div class="form-label">2.2 ç»¼åˆåå¥½</div>
                            <p>æ€»ä½“è€Œè¨€ï¼Œå¦‚æœè¦åœ¨ä¸´åºŠå·¥ä½œä¸­ä½¿ç”¨ï¼Œæ‚¨æ›´åå¥½å“ªä¸ªæ¨¡å‹çš„æŠ¥å‘Šï¼Ÿ</p>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="preference" value="model_a">
                                    <strong>æ¨¡å‹ A</strong>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="preference" value="model_b">
                                    <strong>æ¨¡å‹ B</strong>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="preference" value="no_difference">
                                    <strong>ä¸¤è€…æ— æ˜æ˜¾å·®å¼‚</strong>
                                </label>
                            </div>
                        </div>

                        <!-- å…¶ä»–åé¦ˆ -->
                        <div class="form-group">
                            <label class="form-label" for="additional-feedback">æ‚¨çš„å®è´µæ„è§ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea class="form-control" id="additional-feedback" rows="4" placeholder="å¦‚æœæ‚¨å¯¹æœ¬æ¬¡è¯„ä¼°æˆ–AIæ¨¡å‹æœ‰ä»»ä½•é¢å¤–çš„å»ºè®®æˆ–åé¦ˆï¼Œè¯·åœ¨æ­¤å¤„å¡«å†™"></textarea>
                        </div>

                        <div style="text-align: center; margin-top: 2rem;">
                            <button type="button" class="btn btn-success" onclick="submitSurvey()">æäº¤é—®å·</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ç»“æœç»Ÿè®¡ (ä»…ç®¡ç†å‘˜å¯è§) -->
            <div id="results" class="page">
                <div class="page-header">
                    <h1>è¯„ä¼°ç»“æœç»Ÿè®¡</h1>
                    <p>æŸ¥çœ‹é—®å·æ”¶é›†ç»“æœå’Œæ•°æ®åˆ†æ</p>
                </div>
                <div class="page-content">
                    <div class="disease-tabs">
                        <button class="disease-tab active">æ€»ä½“ç»Ÿè®¡</button>
                        <button class="disease-tab">ä¹³è…ºç™Œ</button>
                        <button class="disease-tab">éå°ç»†èƒè‚ºç™Œ</button>
                    </div>

                    <div class="stats-grid" id="stats-container">
                        <!-- ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>

                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button class="btn btn-primary" onclick="exportResults()">å¯¼å‡ºç»“æœæ•°æ®</button>
                        <button class="btn btn-secondary" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GitHubé…ç½®
        const GITHUB_CONFIG = {
            // GitHub APIé…ç½®
            owner: 'zhouyuru1205',
            repo: 'OncoLLM',
            apiBase: 'https://api.github.com/repos/zhouyuru1205/OncoLLM/contents',
            // GitHub Pagesé…ç½®ï¼ˆç”¨äºè·å–æ–‡ä»¶å†…å®¹ï¼‰
            pagesBase: 'https://zhouyuru1205.github.io/OncoLLM',
            breastPath: 'questionnaires/breast',
            lungPath: 'questionnaires/lung'
        };

        // å…¨å±€å˜é‡
        const userData = {
            currentUser: null,
            githubSurveys: {
                breast: [],
                lung: []
            }
        };

        const surveyData = {
            ratings: {},
            currentSurvey: null
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            
            // ç›‘å¬è¡¨å•å˜åŒ–
            document.addEventListener('change', (e) => {
                if (e.target.type === 'radio') {
                    updateProgress();
                }
            });
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                userData.currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                showLoginPage();
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨
        function showMainApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const user = userData.currentUser;
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('user-avatar').textContent = user.name.charAt(0);
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-title').textContent = user.title + (user.specialty ? ' | ' + user.specialty : '');
            document.getElementById('welcome-text').textContent = `æ¬¢è¿ï¼Œ${user.name} ${user.title}ï¼`;
            
            // æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒåŠŸèƒ½
            if (user.role === 'admin') {
                document.getElementById('admin-nav').style.display = 'flex';
                showPage('admin');
                loadStatistics();
            } else {
                document.getElementById('admin-nav').style.display = 'none';
                showPage('surveys');
            }
            
            // è‡ªåŠ¨åŠ è½½GitHubé—®å·æ•°æ®
            loadGitHubSurveys('breast');
            loadGitHubSurveys('lung');
        }

        // æ³¨å†Œæ­¥éª¤æ§åˆ¶
        let currentStep = 1;

        function nextStep() {
            // éªŒè¯ç¬¬ä¸€æ­¥è¡¨å•
            const name = document.getElementById('doctor-name').value;
            const title = document.getElementById('doctor-title').value;
            const experience = document.getElementById('doctor-experience').value;
            const specialty = document.getElementById('doctor-specialty').value;
            
            if (!name || !title || !experience || !specialty) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼');
                return;
            }
            
            // åˆ‡æ¢åˆ°ç¬¬äºŒæ­¥
            document.getElementById('login-step1').classList.remove('active');
            document.getElementById('login-step2').classList.add('active');
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            currentStep = 2;
        }

        function prevStep() {
            document.getElementById('login-step2').classList.remove('active');
            document.getElementById('login-step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
            currentStep = 1;
        }

        function showRegistration() {
            document.getElementById('direct-login').classList.remove('active');
            document.getElementById('login-step1').classList.add('active');
            // é‡ç½®æ­¥éª¤æŒ‡ç¤ºå™¨
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active', 'completed');
            currentStep = 1;
        }

        function showDirectLogin() {
            document.getElementById('login-step1').classList.remove('active');
            document.getElementById('login-step2').classList.remove('active');
            document.getElementById('direct-login').classList.add('active');
        }

        // å®Œæˆæ³¨å†Œ
        function completeRegistration() {
            // è·å–æ‰€æœ‰è¡¨å•æ•°æ®
            const newUserData = {
                name: document.getElementById('doctor-name').value,
                title: document.getElementById('doctor-title').value,
                experience: document.getElementById('doctor-experience').value,
                specialty: document.getElementById('doctor-specialty').value,
                hospital: document.getElementById('doctor-hospital').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                confirmPassword: document.getElementById('confirm-password').value,
                role: 'doctor',
                registrationTime: new Date().toISOString()
            };
            
            // éªŒè¯æ•°æ®
            if (!newUserData.name || !newUserData.title || !newUserData.experience || 
                !newUserData.specialty || !newUserData.username || !newUserData.password) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼');
                return;
            }
            
            if (newUserData.password !== newUserData.confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }
            
            if (newUserData.password.length < 6) {
                alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }
            
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            if (existingUsers.some(user => user.username === newUserData.username)) {
                alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·åï¼');
                return;
            }
            
            // ä¿å­˜ç”¨æˆ·æ•°æ®
            existingUsers.push(newUserData);
            localStorage.setItem('users', JSON.stringify(existingUsers));
            
            // è‡ªåŠ¨ç™»å½•
            const currentUser = {
                username: newUserData.username,
                name: newUserData.name,
                title: newUserData.title,
                specialty: newUserData.specialty,
                experience: newUserData.experience,
                hospital: newUserData.hospital,
                role: newUserData.role
            };
            
            userData.currentUser = currentUser;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            alert('æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿ä½¿ç”¨AIè¯ç‰©ååº”é¢„æµ‹è¯„ä¼°ç³»ç»Ÿã€‚');
            showMainApp();
        }

        // ç›´æ¥ç™»å½•
        function directLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼');
                return;
            }
            
            // æ£€æŸ¥ç”¨æˆ·
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // æ·»åŠ ç®¡ç†å‘˜è´¦æˆ·åˆ°æ£€æŸ¥åˆ—è¡¨
            const allUsers = [
                {
                    username: 'admin',
                    password: 'admin123',
                    name: 'ç³»ç»Ÿç®¡ç†å‘˜',
                    title: 'ç®¡ç†å‘˜',
                    role: 'admin'
                },
                ...users
            ];
            
            const user = allUsers.find(u => u.username === username && u.password === password);
            
            if (user) {
                const currentUser = {
                    username: user.username,
                    name: user.name,
                    title: user.title,
                    specialty: user.specialty,
                    experience: user.experience,
                    hospital: user.hospital,
                    role: user.role
                };
                
                userData.currentUser = currentUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
            } else {
                alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                userData.currentUser = null;
                localStorage.removeItem('currentUser');
                showLoginPage();
                
                // é‡ç½®è¡¨å•
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            }
        }

        // ä»GitHubåŠ è½½é—®å·æ•°æ®
        async function loadGitHubSurveys(type) {
            const loadingElement = document.getElementById(`${type}-loading`);
            const gridElement = document.getElementById(`${type}-survey-grid`);
            const countElement = document.getElementById(`${type}-count`);
            
            if (loadingElement) loadingElement.style.display = 'inline-block';
            
            try {
                const path = type === 'breast' ? GITHUB_CONFIG.breastPath : GITHUB_CONFIG.lungPath;
                
                // ä½¿ç”¨GitHub APIè·å–æ–‡ä»¶åˆ—è¡¨
                const apiUrl = `${GITHUB_CONFIG.apiBase}/${path}`;
                console.log('æ­£åœ¨è®¿é—®GitHub API:', apiUrl);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`GitHub APIé”™è¯¯ ${response.status}: ${response.statusText}`);
                }
                
                const fileList = await response.json();
                console.log('GitHub APIè¿”å›æ•°æ®:', fileList);
                
                // è¿‡æ»¤å‡º.jsonå’Œ.mdæ–‡ä»¶
                const surveyFiles = fileList.filter(file => 
                    file.type === 'file' && 
                    (file.name.endsWith('.json') || file.name.endsWith('.md'))
                );
                
                console.log(`æ‰¾åˆ° ${surveyFiles.length} ä¸ªé—®å·æ–‡ä»¶:`, surveyFiles.map(f => f.name));
                
                const surveys = [];
                const loadPromises = surveyFiles.slice(0, 20).map(async (file) => { // å¢åŠ åˆ°20ä¸ªæ–‡ä»¶
                    try {
                        // ä½¿ç”¨GitHub Pages URLè·å–æ–‡ä»¶å†…å®¹
                        const fileUrl = `${GITHUB_CONFIG.pagesBase}/${path}/${file.name}`;
                        console.log('åŠ è½½æ–‡ä»¶:', fileUrl);
                        
                        const fileResponse = await fetch(fileUrl);
                        
                        if (fileResponse.ok) {
                            const content = await fileResponse.text();
                            const survey = parseGitHubSurveyData(content, file.name, type);
                            if (survey) {
                                surveys.push(survey);
                                console.log(`æˆåŠŸè§£æ: ${file.name}`);
                            } else {
                                console.warn(`è§£æå¤±è´¥: ${file.name}`);
                            }
                        } else {
                            console.error(`æ–‡ä»¶åŠ è½½å¤±è´¥ ${file.name}: ${fileResponse.status}`);
                        }
                    } catch (error) {
                        console.error(`åŠ è½½æ–‡ä»¶ ${file.name} å¤±è´¥:`, error);
                    }
                });
                
                await Promise.all(loadPromises);
                
                // ä¿å­˜åˆ°å…¨å±€å˜é‡
                userData.githubSurveys[type] = surveys;
                
                // æ›´æ–°æ˜¾ç¤º
                displaySurveys(surveys, gridElement);
                if (countElement) {
                    countElement.textContent = surveys.length;
                }
                
                console.log(`æˆåŠŸåŠ è½½ ${surveys.length} ä¸ª${type === 'breast' ? 'ä¹³è…ºç™Œ' : 'è‚ºç™Œ'}é—®å·`);
                
            } catch (error) {
                console.error('åŠ è½½GitHubé—®å·æ•°æ®å¤±è´¥:', error);
                if (gridElement) {
                    gridElement.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc3545;">
                            <p>åŠ è½½å¤±è´¥</p>
                            <p style="font-size: 0.9rem;">${error.message}</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="loadGitHubSurveys('${type}')">é‡è¯•</button>
                            </div>
                            <div style="margin-top: 1rem; font-size: 0.8rem; color: #666;">
                                <p>è¯·ç¡®ä¿:</p>
                                <p>1. GitHubä»“åº“æ˜¯å…¬å¼€çš„</p>
                                <p>2. æ–‡ä»¶å¤¹ questionnaires/${type} å­˜åœ¨</p>
                                <p>3. ç½‘ç»œè¿æ¥æ­£å¸¸</p>
                            </div>
                        </div>
                    `;
                }
                if (countElement) {
                    countElement.textContent = '0';
                }
            } finally {
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        // è§£æGitHubé—®å·æ•°æ®
        function parseGitHubSurveyData(content, fileName, type) {
            try {
                let survey;
                
                if (fileName.endsWith('.json')) {
                    survey = JSON.parse(content);
                } else if (fileName.endsWith('.md')) {
                    survey = parseMarkdownSurvey(content, fileName);
                } else {
                    throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                }
                
                // æ·»åŠ å…ƒæ•°æ®
                survey.id = fileName.replace(/\.(json|md)$/, '');
                survey.fileName = fileName;
                survey.diseaseType = type === 'breast' ? 'breast_cancer' : 'lung_cancer';
                survey.source = 'github';
                
                return survey;
                
            } catch (error) {
                console.error(`è§£ææ–‡ä»¶ ${fileName} å¤±è´¥:`, error);
                return null;
            }
        }

        // è§£æMarkdownæ ¼å¼é—®å·ï¼ˆä¿®å¤ç‰ˆæœ¬ - ç²¾ç¡®åŒ¹é…å®é™…æ ¼å¼ï¼‰
        function parseMarkdownSurvey(content, fileName) {
            const survey = {
                title: '',
                caseNumber: '',
                patientId: '',
                drugs: [],
                patientInfo: {
                    gender: '',
                    age: '',
                    race: '',
                    ethnicity: '',
                    smoking: '',
                    diagnosis: '',
                    hrStatus: '',
                    her2Status: '',
                    stage: '',
                    ajccStage: '',
                    tmb: '',
                    msiStatus: '',
                    msiScore: '',
                    msiType: '',
                    mutations: '',
                    previousTreatment: '',
                    previousDrugStatus: '',
                    sampleType: '',
                    cancerType: '',
                    cancerDetailType: '',
                    primarySite: '',
                    metastaticSite: '',
                    sampleId: '',
                    structuralVariants: '',
                    clinicalGroup: '',
                    pathologyGroup: '',
                    derivedStage: '',
                    summary: '',
                    laboratoryResults: {}
                },
                modelReports: {
                    modelA: '',
                    modelB: ''
                }
            };
            
            // æå–ç—…ä¾‹ç¼–å·
            const caseMatch = content.match(/\*\*ç—…ä¾‹\s*(\d+)\*\*/);
            if (caseMatch) {
                survey.caseNumber = caseMatch[1];
                survey.title = `ç—…ä¾‹ ${caseMatch[1]}`;
            }
            
            // é€šç”¨æå–å‡½æ•°ï¼ŒåŒ¹é…æ ¼å¼ï¼š- **label:** value
            const extractInfo = (label, field) => {
                const regex = new RegExp(`-\\s*\\*\\*${label.replace(/[()]/g, '\\        // è§£æMarkdownæ ¼å¼é—®å·ï¼ˆæ–°æ ¼å¼é€‚é…ç‰ˆæœ¬ï¼‰
        function parseMarkdownSurvey(content, fileName) {
            const survey = {
                title: '',
                caseNumber: '',
                patientId: '',
                drugs: [],
                patientInfo: {
                    gender: '',
                    age: '',
                    race: '',
                    ethnicity: '',
                    smoking: '',
                    diagnosis: '',
                    hrStatus: '',
                    her2Status: '',
                    stage: '',
                    ajccStage: '',
                    tmb: '',
                    msiStatus: '',
                    msiScore: '',
                    msiType: '',
                    mutations: '',
                    previousTreatment: '',
                    previousDrugStatus: '',
                    sampleType: '',
                    cancerType: '',
                    cancerDetailType: '',
                    primarySite: '',
                    metastaticSite: '',
                    sampleId: '',
                    structuralVariants: '',
                    clinicalGroup: '',
                    pathologyGroup: '',
                    derivedStage: '',
                    summary: '',
                    laboratoryResults: {}
                },
                modelReports: {
                    modelA: '',
                    modelB: ''
                }
            };
            
            // æå–ç—…ä¾‹ç¼–å·
            const caseMatch = content.match(/\*\*ç—…ä¾‹\s*(\d+)\*\*/);
            if (caseMatch) {
                survey.caseNumber = caseMatch[1];
                survey.title = `ç—…ä¾‹ ${caseMatch[1]}`;
            }
            
            // ä»"æ‚£è€…ä¸æ²»ç–—ä¿¡æ¯"éƒ¨åˆ†æå–
            const patientTreatmentMatch = content.match(/\*\*æ‚£è€…ä¸æ²»ç–—ä¿¡æ¯\*\*([\s\S]*?)(?=\*\*è¯ç‰©ä¿¡æ¯\*\*)/);
            if (patientTreatmentMatch) {
                const patientTreatmentInfo = patientTreatmentMatch[1];
                
                // æå–æ‚£è€…ID
                const patientIdMatch = patientTreatmentInfo.match(/-\s*\*\*æ‚£è€…ID:\*\*\s*(P-[\w\d-]+)/);
                if (patientIdMatch) {
                    survey.patientId = patientIdMatch[1];
                }
                
                // æå–æ²»ç–—è¯ç‰©
                const drugMatch = patientTreatmentInfo.match(/-\s*\*\*æ²»ç–—è¯ç‰©:\*\*\s*([^\n\r]+)/);
                if (drugMatch) {
                    let drugText = drugMatch[1];
                    // ç§»é™¤æ‹¬å·å†…çš„è‹±æ–‡åç§°
                    drugText = drugText.replace(/\s*\([^)]+\)/g, '');
                    // ç§»é™¤å¤šä½™çš„é€—å·å’Œç©ºæ ¼
                    drugText = drugText.replace(/[,ï¼Œ]\s*$/, '');
                    survey.drugs = drugText.split(/[,ï¼Œ]/).map(d => d.trim()).filter(d => d.length > 0);
                }
            }
            
            // ä»"ä¸´åºŠä¸è¯Šæ–­ä¿¡æ¯"éƒ¨åˆ†æå–
            const clinicalInfoMatch = content.match(/\*\*ä¸´åºŠä¸è¯Šæ–­ä¿¡æ¯\*\*([\s\S]*?)(?=\*\*æ ·æœ¬ä¸åŸºå› å›¾è°±\*\*|\*\*å®éªŒå®¤ç»“æœ:\*\*)/);
            if (clinicalInfoMatch) {
                const clinicalInfo = clinicalInfoMatch[1];
                
                const extractClinicalInfo = (label, field) => {
                    const regex = new RegExp(`-\\s*\\*\\*${label}:\\*\\*\\s*([^\\n\\r]+)`, 'i');
                    const match = regex.exec(clinicalInfo);
                    if (match) {
                        survey.patientInfo[field] = match[1].trim();
                    }
                };
                
                // æå–åŸºæœ¬ä¿¡æ¯
                extractClinicalInfo('æ€§åˆ«', 'gender');
                extractClinicalInfo('å¹´é¾„', 'age');
                extractClinicalInfo('ç§æ—', 'race');
                extractClinicalInfo('æ—è£”', 'ethnicity');
                extractClinicalInfo('å¸çƒŸå²', 'smoking');
                extractClinicalInfo('åˆ†æœŸï¼ˆæœ€é«˜è®°å½•ï¼‰', 'stage');
                extractClinicalInfo('æ—¢å¾€ç”¨è¯çŠ¶æ€', 'previousDrugStatus');
                extractClinicalInfo('æ—¢å¾€æ²»ç–—', 'previousTreatment');
                extractClinicalInfo('è¯Šæ–­', 'diagnosis');
                extractClinicalInfo('AJCCåˆ†æœŸ', 'ajccStage');
                extractClinicalInfo('ä¸´åºŠç»„åˆ«', 'clinicalGroup');
                extractClinicalInfo('ç—…ç†ç»„åˆ«', 'pathologyGroup');
                extractClinicalInfo('è¡ç”Ÿåˆ†æœŸ', 'derivedStage');
                extractClinicalInfo('æ‘˜è¦', 'summary');
            }
            
            // æå–å®éªŒå®¤ç»“æœ
            const labResultsMatch = content.match(/\*\*å®éªŒå®¤ç»“æœ:\*\*([\s\S]*?)(?=\*\*æ ·æœ¬ä¸åŸºå› å›¾è°±\*\*|---)/);
            if (labResultsMatch) {
                const labInfo = labResultsMatch[1];
                
                // æå–CEAå’ŒCA 15-3ç»“æœï¼ˆæ”¯æŒå¤šä¸ªæ—¶é—´ç‚¹ï¼‰
                const ceaMatches = labInfo.match(/-\s*\*\*CEA:\*\*\s*([^\n\r]+)/g);
                if (ceaMatches && ceaMatches.length > 0) {
                    const ceaValues = ceaMatches.map(match => 
                        match.replace(/-\s*\*\*CEA:\*\*\s*/, '').trim()
                    );
                    survey.patientInfo.laboratoryResults.CEA = ceaValues.join('; ');
                }
                
                const ca153Matches = labInfo.match(/-\s*\*\*CA\s*15-3:\*\*\s*([^\n\r]+)/g);
                if (ca153Matches && ca153Matches.length > 0) {
                    const ca153Values = ca153Matches.map(match => 
                        match.replace(/-\s*\*\*CA\s*15-3:\*\*\s*/, '').trim()
                    );
                    survey.patientInfo.laboratoryResults['CA 15-3'] = ca153Values.join('; ');
                }
                
                const ca199Matches = labInfo.match(/-\s*\*\*CA\s*19-9:\*\*\s*([^\n\r]+)/g);
                if (ca199Matches && ca199Matches.length > 0) {
                    const ca199Values = ca199Matches.map(match => 
                        match.replace(/-\s*\*\*CA\s*19-9:\*\*\s*/, '').trim()
                    );
                    survey.patientInfo.laboratoryResults['CA 19-9'] = ca199Values.join('; ');
                }
            }
            
            // ä»"æ ·æœ¬ä¸åŸºå› å›¾è°±"éƒ¨åˆ†æå–
            const sampleGeneMatch = content.match(/\*\*æ ·æœ¬ä¸åŸºå› å›¾è°±\*\*([\s\S]*?)(?=---|---)/);
            if (sampleGeneMatch) {
                const sampleGeneInfo = sampleGeneMatch[1];
                
                const extractSampleInfo = (label, field) => {
                    const regex = new RegExp(`-\\s*\\*\\*${label}:\\*\\*\\s*([^\\n\\r]+)`, 'i');
                    const match = regex.exec(sampleGeneInfo);
                    if (match) {
                        survey.patientInfo[field] = match[1].trim();
                    }
                };
                
                // æå–æ ·æœ¬å’ŒåŸºå› ä¿¡æ¯
                extractSampleInfo('æ ·æœ¬ID', 'sampleId');
                extractSampleInfo('ç™Œç—‡ç±»å‹', 'cancerType');
                extractSampleInfo('ç™Œç—‡è¯¦ç»†ç±»å‹', 'cancerDetailType');
                extractSampleInfo('åŸå‘éƒ¨ä½', 'primarySite');
                extractSampleInfo('è½¬ç§»éƒ¨ä½', 'metastaticSite');
                extractSampleInfo('æ ·æœ¬ç±»å‹', 'sampleType');
                extractSampleInfo('MSIçŠ¶æ€', 'msiStatus');
                extractSampleInfo('MSIè¯„åˆ†', 'msiScore');
                extractSampleInfo('MSIç±»å‹', 'msiType');
                extractSampleInfo('TMB \\(éåŒä¹‰çªå˜\\)', 'tmb');
                extractSampleInfo('åŸºå› çªå˜', 'mutations');
                extractSampleInfo('ç»“æ„å˜å¼‚', 'structuralVariants');
            }
            
            // æå–æ¨¡å‹Açš„åˆ†æéƒ¨åˆ†
            const modelAMatch = content.match(/<summary>ç‚¹å‡»æŸ¥çœ‹æ¨¡å‹AæŠ¥å‘Šå…¨æ–‡<\/summary>([\s\S]*?)<\/details>/);
            if (modelAMatch) {
                const reportContent = modelAMatch[1];
                const aiAnalysisMatch = reportContent.match(/\*\*5\.\s*AIç”Ÿæˆåˆ†æ\*\*([\s\S]*?)(?=\*\*æ³¨:|\*\*ä¸´åºŠæ„ä¹‰:|\*\*æœ€ç»ˆè¯´æ˜:|---|\*\*å…³é”®æç¤º|$)/);
                if (aiAnalysisMatch) {
                    survey.modelReports.modelA = aiAnalysisMatch[1].trim();
                }
            }
            
            // æå–æ¨¡å‹Bçš„åˆ†æéƒ¨åˆ†
            const modelBMatch = content.match(/<summary>ç‚¹å‡»æŸ¥çœ‹æ¨¡å‹BæŠ¥å‘Šå…¨æ–‡<\/summary>([\s\S]*?)<\/details>/);
            if (modelBMatch) {
                const reportContent = modelBMatch[1];
                const aiAnalysisMatch = reportContent.match(/\*\*5\.\s*AIç”Ÿæˆåˆ†æ\*\*([\s\S]*?)(?=\*\*æ³¨:|\*\*ä¸´åºŠæ„ä¹‰:|\*\*æœ€ç»ˆè¯´æ˜:|---|\*\*å…³é”®æç¤º|$)/);
                if (aiAnalysisMatch) {
                    survey.modelReports.modelB = aiAnalysisMatch[1].trim();
                }
            }
            
            // è¯¦ç»†è°ƒè¯•è¾“å‡º
            console.log(`=== è§£æ ${fileName} (æ–°æ ¼å¼) ===`);
            console.log('ç—…ä¾‹ä¿¡æ¯:', {
                title: survey.title,
                patientId: survey.patientId,
                drugs: survey.drugs
            });
            console.log('åŸºæœ¬ä¿¡æ¯:', {
                gender: survey.patientInfo.gender,
                age: survey.patientInfo.age,
                race: survey.patientInfo.race,
                diagnosis: survey.patientInfo.diagnosis
            });
            console.log('åˆ†æœŸä¿¡æ¯:', {
                stage: survey.patientInfo.stage,
                ajccStage: survey.patientInfo.ajccStage,
                clinicalGroup: survey.patientInfo.clinicalGroup
            });
            console.log('æ²»ç–—ä¿¡æ¯:', {
                previousTreatment: survey.patientInfo.previousTreatment,
                tmb: survey.patientInfo.tmb
            });
            console.log('å®éªŒå®¤ç»“æœ:', survey.patientInfo.laboratoryResults);
            console.log('æ¨¡å‹æŠ¥å‘Š:', {
                hasModelA: !!survey.modelReports.modelA,
                hasModelB: !!survey.modelReports.modelB,
                modelALength: survey.modelReports.modelA.length,
                modelBLength: survey.modelReports.modelB.length
            });
            
            return survey;
        }')}:\\*\\*\\s*([^\\n\\r]+)`, 'i');
                const match = regex.exec(content);
                if (match) {
                    survey.patientInfo[field] = match[1].trim();
                }
            };
            
            // æå–æ‚£è€…IDå’Œæ²»ç–—è¯ç‰©
            const patientIdMatch = content.match(/-\s*\*\*æ‚£è€…ID:\*\*\s*(P-[\w\d-]+)/);
            if (patientIdMatch) {
                survey.patientId = patientIdMatch[1];
            }
            
            const drugMatch = content.match(/-\s*\*\*æ²»ç–—è¯ç‰©:\*\*\s*([^\n\r]+)/);
            if (drugMatch) {
                let drugText = drugMatch[1];
                // ç§»é™¤æ‹¬å·å†…çš„è‹±æ–‡åç§°
                drugText = drugText.replace(/\s*\([^)]+\)/g, '');
                survey.drugs = drugText.split(/[,ï¼Œ]/).map(d => d.trim()).filter(d => d.length > 0);
            }
            
            // æå–ä¸´åºŠä¸è¯Šæ–­ä¿¡æ¯
            extractInfo('æ€§åˆ«', 'gender');
            extractInfo('å¹´é¾„', 'age');
            extractInfo('ç§æ—', 'race');
            extractInfo('æ—è£”', 'ethnicity');
            extractInfo('å¸çƒŸå²', 'smoking');
            extractInfo('åˆ†æœŸï¼ˆæœ€é«˜è®°å½•ï¼‰', 'stage');
            extractInfo('æ—¢å¾€ç”¨è¯çŠ¶æ€', 'previousDrugStatus');
            extractInfo('æ—¢å¾€æ²»ç–—', 'previousTreatment');
            extractInfo('è¯Šæ–­', 'diagnosis');
            extractInfo('AJCCåˆ†æœŸ', 'ajccStage');
            extractInfo('ä¸´åºŠç»„åˆ«', 'clinicalGroup');
            extractInfo('ç—…ç†ç»„åˆ«', 'pathologyGroup');
            extractInfo('è¡ç”Ÿåˆ†æœŸ', 'derivedStage');
            extractInfo('æ‘˜è¦', 'summary');
            
            // æå–æ ·æœ¬ä¸åŸºå› å›¾è°±ä¿¡æ¯
            extractInfo('æ ·æœ¬ID', 'sampleId');
            extractInfo('ç™Œç—‡ç±»å‹', 'cancerType');
            extractInfo('ç™Œç—‡è¯¦ç»†ç±»å‹', 'cancerDetailType');
            extractInfo('åŸå‘éƒ¨ä½', 'primarySite');
            extractInfo('è½¬ç§»éƒ¨ä½', 'metastaticSite');
            extractInfo('æ ·æœ¬ç±»å‹', 'sampleType');
            extractInfo('MSIçŠ¶æ€', 'msiStatus');
            extractInfo('MSIè¯„åˆ†', 'msiScore');
            extractInfo('MSIç±»å‹', 'msiType');
            extractInfo('TMB \\(éåŒä¹‰çªå˜\\)', 'tmb');
            extractInfo('åŸºå› çªå˜', 'mutations');
            extractInfo('ç»“æ„å˜å¼‚', 'structuralVariants');
            
            // æå–å®éªŒå®¤ç»“æœ
            const extractLabResults = () => {
                // CEAç»“æœ - æ”¯æŒå¤šä¸ªæ—¶é—´ç‚¹
                const ceaMatches = content.match(/-\s*\*\*CEA:\*\*\s*([^\n\r]+)/g);
                if (ceaMatches && ceaMatches.length > 0) {
                    const ceaValues = ceaMatches.map(match => 
                        match.replace(/-\s*\*\*CEA:\*\*\s*/, '').trim()
                    );
                    survey.patientInfo.laboratoryResults.CEA = ceaValues.join('; ');
                }
                
                // CA 15-3ç»“æœ
                const ca153Matches = content.match(/-\s*\*\*CA\s*15-3:\*\*\s*([^\n\r]+)/g);
                if (ca153Matches && ca153Matches.length > 0) {
                    const ca153Values = ca153Matches.map(match => 
                        match.replace(/-\s*\*\*CA\s*15-3:\*\*\s*/, '').trim()
                    );
                    survey.patientInfo.laboratoryResults['CA 15-3'] = ca153Values.join('; ');
                }
                
                // CA 19-9ç»“æœ
                const ca199Matches = content.match(/-\s*\*\*CA\s*19-9:\*\*\s*([^\n\r]+)/g);
                if (ca199Matches && ca199Matches.length > 0) {
                    const ca199Values = ca199Matches.map(match => 
                        match.replace(/-\s*\*\*CA\s*19-9:\*\*\s*/, '').trim()
                    );
                    survey.patientInfo.laboratoryResults['CA 19-9'] = ca199Values.join('; ');
                }
            };
            
            extractLabResults();
            
            // æå–æ¨¡å‹Açš„åˆ†æéƒ¨åˆ†
            const modelAMatch = content.match(/<summary>ç‚¹å‡»æŸ¥çœ‹æ¨¡å‹AæŠ¥å‘Šå…¨æ–‡<\/summary>([\s\S]*?)<\/details>/);
            if (modelAMatch) {
                const reportContent = modelAMatch[1];
                const aiAnalysisMatch = reportContent.match(/\*\*5\.\s*AIç”Ÿæˆåˆ†æ\*\*([\s\S]*?)(?=\*\*æ³¨:|---|\*\*å…³é”®æç¤º|$)/);
                if (aiAnalysisMatch) {
                    survey.modelReports.modelA = aiAnalysisMatch[1].trim();
                }
            }
            
            // æå–æ¨¡å‹Bçš„åˆ†æéƒ¨åˆ†
            const modelBMatch = content.match(/<summary>ç‚¹å‡»æŸ¥çœ‹æ¨¡å‹BæŠ¥å‘Šå…¨æ–‡<\/summary>([\s\S]*?)<\/details>/);
            if (modelBMatch) {
                const reportContent = modelBMatch[1];
                const aiAnalysisMatch = reportContent.match(/\*\*5\.\s*AIç”Ÿæˆåˆ†æ\*\*([\s\S]*?)(?=\*\*æ³¨:|---|\*\*ä¸´åºŠæ„ä¹‰:|\*\*æœ€ç»ˆè¯´æ˜:|$)/);
                if (aiAnalysisMatch) {
                    survey.modelReports.modelB = aiAnalysisMatch[1].trim();
                }
            }
            
            // è¯¦ç»†è°ƒè¯•è¾“å‡º
            console.log(`=== è§£æ ${fileName} (ä¿®å¤ç‰ˆæœ¬) ===`);
            console.log('ç—…ä¾‹ä¿¡æ¯:', {
                title: survey.title,
                patientId: survey.patientId,
                drugs: survey.drugs
            });
            console.log('åŸºæœ¬ä¿¡æ¯:', {
                gender: survey.patientInfo.gender,
                age: survey.patientInfo.age,
                race: survey.patientInfo.race,
                diagnosis: survey.patientInfo.diagnosis
            });
            console.log('åˆ†æœŸä¿¡æ¯:', {
                stage: survey.patientInfo.stage,
                ajccStage: survey.patientInfo.ajccStage,
                clinicalGroup: survey.patientInfo.clinicalGroup,
                pathologyGroup: survey.patientInfo.pathologyGroup
            });
            console.log('åŸºå› ä¿¡æ¯:', {
                tmb: survey.patientInfo.tmb,
                msiStatus: survey.patientInfo.msiStatus,
                mutations: survey.patientInfo.mutations ? survey.patientInfo.mutations.substring(0, 100) + '...' : 'æ— '
            });
            console.log('æ ·æœ¬ä¿¡æ¯:', {
                sampleId: survey.patientInfo.sampleId,
                cancerType: survey.patientInfo.cancerType,
                primarySite: survey.patientInfo.primarySite
            });
            console.log('å®éªŒå®¤ç»“æœ:', survey.patientInfo.laboratoryResults);
            console.log('æ¨¡å‹æŠ¥å‘Š:', {
                hasModelA: !!survey.modelReports.modelA,
                hasModelB: !!survey.modelReports.modelB,
                modelALength: survey.modelReports.modelA.length,
                modelBLength: survey.modelReports.modelB.length
            });
            
            if (survey.modelReports.modelA) {
                console.log('æ¨¡å‹Aå¼€å¤´:', survey.modelReports.modelA.substring(0, 150) + '...');
            }
            if (survey.modelReports.modelB) {
                console.log('æ¨¡å‹Bå¼€å¤´:', survey.modelReports.modelB.substring(0, 150) + '...');
            }
            
            return survey;
        }

        // æ˜¾ç¤ºé—®å·åˆ—è¡¨
        function displaySurveys(surveys, container) {
            if (!container) return;
            
            if (surveys.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>æš‚æ— é—®å·æ•°æ®</p>
                        <p style="font-size: 0.9rem;">è¯·æ£€æŸ¥GitHubæ•°æ®æº</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            surveys.forEach(survey => {
                const surveyCard = document.createElement('div');
                surveyCard.className = 'survey-card';
                surveyCard.onclick = () => openGitHubSurvey(survey);
                
                const drugsText = Array.isArray(survey.drugs) ? 
                    survey.drugs.join(' + ') : 
                    (survey.drug || survey.drugs || 'æœªçŸ¥è¯ç‰©');
                
                surveyCard.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${survey.title || survey.fileName}</div>
                        <div class="card-status status-pending">GitHub</div>
                    </div>
                    <div class="card-info">
                        <strong>æ‚£è€…ID:</strong> ${survey.patientId || 'æœªçŸ¥'}<br>
                        <strong>æ²»ç–—è¯ç‰©:</strong> ${drugsText}<br>
                        <small style="color: #666;">æ–‡ä»¶: ${survey.fileName}</small>
                    </div>
                `;
                
                container.appendChild(surveyCard);
            });
        }

        // æ‰“å¼€GitHubé—®å·
        function openGitHubSurvey(survey) {
            surveyData.currentSurvey = survey;
            renderSurveyDetail(survey);
            showPage('survey-detail');
        }

        // æ¸²æŸ“é—®å·è¯¦æƒ…
        function renderSurveyDetail(survey) {
            const patientInfo = survey.patientInfo || {};
            const drugs = Array.isArray(survey.drugs) ? survey.drugs : [survey.drug || survey.drugs];
            const drugsText = drugs.filter(d => d).join(' + ');
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const pageHeader = document.querySelector('#survey-detail .page-header h1');
            if (pageHeader) {
                pageHeader.textContent = `${survey.title || survey.fileName} - è¯ç‰©ååº”é¢„æµ‹è¯„ä¼°`;
            }
            
            // ç”Ÿæˆæ‚£è€…ä¿¡æ¯
            const patientInfoContainer = document.getElementById('patient-info-grid');
            if (patientInfoContainer) {
                patientInfoContainer.innerHTML = generatePatientInfoHTML(survey, patientInfo, drugsText);
            }
            
            // æ›´æ–°æ¨¡å‹æŠ¥å‘Š
            updateModelReports(survey.modelReports);
            
            // é‡ç½®è¡¨å•
            const form = document.getElementById('survey-form');
            if (form) {
                form.reset();
            }
            
            // é‡ç½®è¯„åˆ†
            surveyData.ratings = {};
            document.querySelectorAll('.rating-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            updateProgress();
        }

        // ç”Ÿæˆæ‚£è€…ä¿¡æ¯HTML
        function generatePatientInfoHTML(survey, patientInfo, drugsText) {
            let html = '';
            
            // åŸºæœ¬æ ‡è¯†ä¿¡æ¯
            html += createInfoItem('æ‚£è€…ID', survey.patientId);
            html += createInfoItem('æ²»ç–—è¯ç‰©', drugsText);
            
            // åŸºæœ¬ä¿¡æ¯
            if (patientInfo.gender) html += createInfoItem('æ€§åˆ«', patientInfo.gender);
            if (patientInfo.age) html += createInfoItem('å¹´é¾„', patientInfo.age);
            if (patientInfo.race) html += createInfoItem('ç§æ—', patientInfo.race);
            if (patientInfo.ethnicity) html += createInfoItem('æ—è£”', patientInfo.ethnicity);
            if (patientInfo.smoking) html += createInfoItem('å¸çƒŸå²', patientInfo.smoking);
            
            // è¯Šæ–­ä¸åˆ†æœŸ
            if (patientInfo.diagnosis) html += createInfoItem('è¯Šæ–­', patientInfo.diagnosis);
            if (patientInfo.stage) html += createInfoItem('åˆ†æœŸï¼ˆæœ€é«˜è®°å½•ï¼‰', patientInfo.stage);
            if (patientInfo.ajccStage) html += createInfoItem('AJCCåˆ†æœŸ', patientInfo.ajccStage);
            if (patientInfo.clinicalGroup) html += createInfoItem('ä¸´åºŠç»„åˆ«', patientInfo.clinicalGroup);
            if (patientInfo.pathologyGroup) html += createInfoItem('ç—…ç†ç»„åˆ«', patientInfo.pathologyGroup);
            if (patientInfo.derivedStage) html += createInfoItem('è¡ç”Ÿåˆ†æœŸ', patientInfo.derivedStage);
            if (patientInfo.summary) html += createInfoItem('æ‘˜è¦', patientInfo.summary);
            
            // æ²»ç–—ç›¸å…³
            if (patientInfo.previousDrugStatus) html += createInfoItem('æ—¢å¾€ç”¨è¯çŠ¶æ€', patientInfo.previousDrugStatus);
            if (patientInfo.previousTreatment) html += createInfoItem('æ—¢å¾€æ²»ç–—', patientInfo.previousTreatment);
            
            // ç”Ÿç‰©æ ‡å¿—ç‰©
            if (patientInfo.hrStatus) html += createInfoItem('HRçŠ¶æ€', patientInfo.hrStatus);
            if (patientInfo.her2Status) html += createInfoItem('HER2çŠ¶æ€', patientInfo.her2Status);
            
            // åŸºå› ä¿¡æ¯
            if (patientInfo.tmb) html += createInfoItem('TMB (éåŒä¹‰çªå˜)', patientInfo.tmb);
            if (patientInfo.msiStatus) html += createInfoItem('MSIçŠ¶æ€', patientInfo.msiStatus);
            if (patientInfo.msiScore) html += createInfoItem('MSIè¯„åˆ†', patientInfo.msiScore);
            if (patientInfo.msiType) html += createInfoItem('MSIç±»å‹', patientInfo.msiType);
            if (patientInfo.structuralVariants) html += createInfoItem('ç»“æ„å˜å¼‚', patientInfo.structuralVariants);
            
            // æ ·æœ¬ä¿¡æ¯
            if (patientInfo.sampleId) html += createInfoItem('æ ·æœ¬ID', patientInfo.sampleId);
            if (patientInfo.cancerType) html += createInfoItem('ç™Œç—‡ç±»å‹', patientInfo.cancerType);
            if (patientInfo.cancerDetailType) html += createInfoItem('ç™Œç—‡è¯¦ç»†ç±»å‹', patientInfo.cancerDetailType);
            if (patientInfo.primarySite) html += createInfoItem('åŸå‘éƒ¨ä½', patientInfo.primarySite);
            if (patientInfo.metastaticSite) html += createInfoItem('è½¬ç§»éƒ¨ä½', patientInfo.metastaticSite);
            if (patientInfo.sampleType) html += createInfoItem('æ ·æœ¬ç±»å‹', patientInfo.sampleType);
            
            // å®éªŒå®¤ç»“æœ
            if (patientInfo.laboratoryResults && Object.keys(patientInfo.laboratoryResults).length > 0) {
                for (const [key, value] of Object.entries(patientInfo.laboratoryResults)) {
                    if (value) html += createInfoItem(key, value);
                }
            }
            
            // åŸºå› çªå˜ (æ”¾åœ¨æœ€åï¼Œå¯èƒ½å¾ˆé•¿)
            if (patientInfo.mutations) {
                html += `
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <div class="info-label">åŸºå› çªå˜</div>
                        <div class="info-value" style="word-break: break-all; line-height: 1.4;">${patientInfo.mutations}</div>
                    </div>
                `;
            }
            
            return html;
        }

        // åˆ›å»ºä¿¡æ¯é¡¹HTML
        function createInfoItem(label, value) {
            if (!value) return '';
            return `
                <div class="info-item">
                    <div class="info-label">${label}</div>
                    <div class="info-value">${value}</div>
                </div>
            `;
        }

        // æ›´æ–°æ¨¡å‹æŠ¥å‘Š
        function updateModelReports(modelReports) {
            if (!modelReports) return;
            
            const modelAContent = document.getElementById('modelA-content');
            const modelBContent = document.getElementById('modelB-content');
            
            if (modelAContent && modelReports.modelA) {
                modelAContent.innerHTML = formatModelReport(modelReports.modelA);
            }
            
            if (modelBContent && modelReports.modelB) {
                modelBContent.innerHTML = formatModelReport(modelReports.modelB);
            }
        }

        // æ ¼å¼åŒ–æ¨¡å‹æŠ¥å‘Š
        function formatModelReport(reportText) {
            if (!reportText) return '';
            
            return reportText
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^\s*/, '<p>')
                .replace(/\s*$/, '</p>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        // é¡µé¢åˆ‡æ¢
        function showPage(pageId) {
            // æƒé™æ£€æŸ¥
            if ((pageId === 'admin' || pageId === 'results') && userData.currentUser.role !== 'admin') {
                alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®è¯¥é¡µé¢ï¼');
                return;
            }
            
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(pageId).classList.add('active');
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn => 
                btn.textContent.includes(getPageTitle(pageId))
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }

        function getPageTitle(pageId) {
            const titles = {
                'admin': 'ç®¡ç†ç•Œé¢',
                'surveys': 'é—®å·å¡«å†™', 
                'survey-detail': 'é—®å·è¯¦æƒ…',
                'results': 'ç»“æœç»Ÿè®¡'
            };
            return titles[pageId] || '';
        }

        // æ ‡ç­¾åˆ‡æ¢
        function switchDiseaseTab(disease, element) {
            element.parentElement.querySelectorAll('.disease-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            document.querySelectorAll('.disease-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(disease + '_content').style.display = 'block';
        }

        function switchSurveyTab(type, element) {
            element.parentElement.querySelectorAll('.disease-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            document.querySelectorAll('.survey-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(type + '-survey-list').style.display = 'block';
        }

        // è¯„åˆ†åŠŸèƒ½
        function setRating(category, value, element) {
            surveyData.ratings[category] = value;
            
            const container = element.parentElement;
            container.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
            
            updateProgress();
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const form = document.getElementById('survey-form');
            if (!form) return;
            
            const requiredInputs = form.querySelectorAll('input[type="radio"]:checked');
            const totalRequired = 8; // é¢„æµ‹ + åå¥½ + 6ä¸ªè¯„åˆ†ç»´åº¦
            const progress = Math.min((requiredInputs.length / totalRequired) * 100, 100);
            
            const progressFill = document.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
        }

        // åˆ‡æ¢æŠ¥å‘Šæ˜¾ç¤º
        function toggleReport(modelId) {
            const content = document.getElementById(modelId + '-content');
            const toggle = document.getElementById(modelId + '-toggle');
            
            if (content && toggle) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = 'æ”¶èµ· â–²';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = 'å±•å¼€ â–¼';
                }
            }
        }

        // æäº¤é—®å·
        function submitSurvey() {
            const form = document.getElementById('survey-form');
            if (!form) return;
            
            if (!surveyData.currentSurvey) {
                alert('é—®å·æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°é€‰æ‹©é—®å·ï¼');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!data.prediction) {
                alert('è¯·é€‰æ‹©æ‚¨çš„é¢„æµ‹ç»“æœï¼');
                return;
            }
            
            if (!data.preference) {
                alert('è¯·é€‰æ‹©æ‚¨çš„æ¨¡å‹åå¥½ï¼');
                return;
            }
            
            // æ·»åŠ è¯„åˆ†æ•°æ®
            data.ratings = surveyData.ratings;
            data.additionalFeedback = document.getElementById('additional-feedback')?.value || '';
            data.timestamp = new Date().toISOString();
            data.doctorInfo = userData.currentUser;
            data.surveyInfo = {
                id: surveyData.currentSurvey.id,
                fileName: surveyData.currentSurvey.fileName,
                patientId: surveyData.currentSurvey.patientId,
                title: surveyData.currentSurvey.title,
                diseaseType: surveyData.currentSurvey.diseaseType,
                source: surveyData.currentSurvey.source
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const existingResults = JSON.parse(localStorage.getItem('surveyResults') || '[]');
            existingResults.push(data);
            localStorage.setItem('surveyResults', JSON.stringify(existingResults));
            
            console.log('é—®å·æäº¤æˆåŠŸ:', data);
            
            alert('é—®å·æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚');
            
            // åˆ·æ–°ç»Ÿè®¡æ•°æ®
            if (userData.currentUser.role === 'admin') {
                loadStatistics();
            }
            
            showPage('surveys');
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStatistics() {
            try {
                const surveyResults = JSON.parse(localStorage.getItem('surveyResults') || '[]');
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                // è®¡ç®—æ€»é—®å·æ•°ï¼ˆä»GitHubæ•°æ®ï¼‰
                const totalGithubSurveys = userData.githubSurveys.breast.length + userData.githubSurveys.lung.length;
                const completed = surveyResults.length;
                const completionRate = totalGithubSurveys > 0 ? ((completed / totalGithubSurveys) * 100).toFixed(1) : '0';
                
                const statsContainer = document.getElementById('stats-container');
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <div class="stat-card">
                            <h3 style="color: #667eea; margin-bottom: 1rem;">æ€»é—®å·æ•°</h3>
                            <div class="stat-number">${totalGithubSurveys}</div>
                            <div class="stat-label">GitHubé—®å·</div>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: #28a745; margin-bottom: 1rem;">å·²å®Œæˆ</h3>
                            <div class="stat-number">${completed}</div>
                            <div class="stat-label">å®Œæˆç‡: ${completionRate}%</div>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: #17a2b8; margin-bottom: 1rem;">ä¹³è…ºç™Œ</h3>
                            <div class="stat-number">${userData.githubSurveys.breast.length}</div>
                            <div class="stat-label">å¯ç”¨é—®å·</div>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: #ffc107; margin-bottom: 1rem;">è‚ºç™Œ</h3>
                            <div class="stat-number">${userData.githubSurveys.lung.length}</div>
                            <div class="stat-label">å¯ç”¨é—®å·</div>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: #dc3545; margin-bottom: 1rem;">æ³¨å†ŒåŒ»ç”Ÿ</h3>
                            <div class="stat-number">${users.length}</div>
                            <div class="stat-label">å‚ä¸ä¸“å®¶</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            try {
                const surveyResults = JSON.parse(localStorage.getItem('surveyResults') || '[]');
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                const results = {
                    summary: {
                        totalGitHubSurveys: userData.githubSurveys.breast.length + userData.githubSurveys.lung.length,
                        breastSurveys: userData.githubSurveys.breast.length,
                        lungSurveys: userData.githubSurveys.lung.length,
                        completedSurveys: surveyResults.length,
                        totalUsers: users.length,
                        completionRate: ((surveyResults.length / (userData.githubSurveys.breast.length + userData.githubSurveys.lung.length)) * 100).toFixed(1) + '%'
                    },
                    gitHubSurveys: {
                        breast: userData.githubSurveys.breast.map(s => ({
                            id: s.id,
                            fileName: s.fileName,
                            title: s.title,
                            patientId: s.patientId,
                            drugs: s.drugs
                        })),
                        lung: userData.githubSurveys.lung.map(s => ({
                            id: s.id,
                            fileName: s.fileName,
                            title: s.title,
                            patientId: s.patientId,
                            drugs: s.drugs
                        }))
                    },
                    surveyResults: surveyResults,
                    users: users.map(user => ({
                        name: user.name,
                        title: user.title,
                        specialty: user.specialty,
                        experience: user.experience,
                        hospital: user.hospital,
                        registrationTime: user.registrationTime
                    })),
                    exportTime: new Date().toISOString(),
                    exportedBy: userData.currentUser?.name || 'ç³»ç»Ÿç®¡ç†å‘˜'
                };
                
                const dataStr = JSON.stringify(results, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'survey_results_' + new Date().toISOString().slice(0,10) + '.json';
                a.click();
                URL.revokeObjectURL(url);
                
                alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å¡«å†™ç»“æœï¼\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (confirm('è¯·å†æ¬¡ç¡®è®¤ï¼šæ‚¨çœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                    localStorage.removeItem('surveyResults');
                    loadStatistics();
                    alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
                }
            }
        }
    </script>
</body>
</html>
